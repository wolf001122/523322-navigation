<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>导航</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<script async
  src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9474229114991789"
  crossorigin="anonymous"></script>

<style>
/* ======== 原 CSS，未删未改 ======== */
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
  background:#f8f9fa;
  color:#202124;
  height:100vh;
  overflow:hidden;
}
#layout{display:flex;height:100vh;width:100vw;}
#sidebar{
  width:240px;
  background:#fff;
  border-right:1px solid #dadce0;
  display:flex;
  flex-direction:column;
  box-shadow:0 1px 2px 0 rgba(60,64,67,0.3),0 1px 3px 1px rgba(60,64,67,0.15);
  flex-shrink:0;
  transition: transform 0.3s ease;
}
#logo{
  padding:24px 20px;
  font-size:24px;
  font-weight:700;
  text-align:center;
  color:#5f6368;
  border-bottom:1px solid #dadce0;
  cursor:default;
  position:relative;
}
#logo.return-mode{color:#1a73e8;cursor:pointer;}
#cats{flex:1;overflow-y:auto;padding:8px 0;}
.cat{padding:14px 24px;cursor:pointer;font-size:15px;color:#3c4043;}
.cat.active{background:#1a73e8;color:#fff;}
#side-bottom{
  border-top:1px solid #dadce0;
  padding:16px 24px;
  font-size:14px;
  color:#5f6368;
}
#overlay{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.5);
  z-index:199;
}
#hamburger{
  display:none;
  position:fixed;
  top:16px;
  left:16px;
  width:28px;
  height:22px;
  cursor:pointer;
  flex-direction:column;
  justify-content:space-between;
  z-index:201;
}
#hamburger span{
  display:block;
  height:4px;
  background:#202124;
  border-radius:2px;
}
#main{flex:1;overflow:hidden;display:flex;flex-direction:column;}
#ad-top{background:#fff;border-bottom:1px solid #dadce0;padding:12px;text-align:center;}
#search-page{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;}
#search-box{display:flex;width:100%;max-width:680px;}
#search-box input{flex:1;padding:16px;font-size:18px;border:1px solid #dadce0;border-radius:28px 0 0 28px;}
#search-box button{padding:0 24px;border:1px solid #dadce0;border-left:none;border-radius:0 28px 28px 0;background:#1a73e8;color:#fff;}
#engines{margin-top:20px;display:flex;gap:12px;}
#engines button.active{background:#e8f0fe;color:#1a73e8;}
#content{flex:1;display:none;overflow:auto;padding:16px;}
.ad-box{margin:32px 0;padding:16px;background:#fff;border:1px solid #dadce0;border-radius:8px;text-align:center;}
.category-title{font-size:28px;margin-bottom:8px;}
.sub-title{font-size:18px;margin:24px 0 12px;}
.links{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;}
.card{display:flex;align-items:center;padding:16px;background:#fff;border-radius:12px;text-decoration:none;color:inherit;height:96px;}
.card img{width:48px;height:48px;background:#f8f9fa;border-radius:8px;padding:4px;}
.text{margin-left:16px;}
iframe{flex:1;border:none;}

@media (max-width:768px){
  #sidebar{
    position:fixed;
    top:0;left:0;height:100%;
    width:280px;
    z-index:200;
    transform:translateX(-100%);
  }
  #sidebar.visible{transform:translateX(0);}
  #hamburger{display:flex;}
  body.sidebar-open #overlay{display:block;}
}
</style>
</head>

<body>
<div id="layout">
  <div id="sidebar">
    <div id="logo" onclick="backToSearch()">导　航</div>
    <div id="cats"></div>
    <div id="side-bottom">
      <div onclick="loadExternal('/submit.html')">网站提交</div>
      <div onclick="loadExternal('/privacy.html')">隐私政策</div>
      <div onclick="loadExternal('/links.html')">友情链接</div>
      <div onclick="loadExternal('/about.html')">关于导航</div>
    </div>
  </div>

  <div id="main">
    <div id="overlay" onclick="toggleSidebar()"></div>
    <div id="hamburger" onclick="toggleSidebar()">
      <span></span><span></span><span></span>
    </div>

    <div id="ad-top">
      <ins class="adsbygoogle" style="display:block"
        data-ad-client="ca-pub-9474229114991789"
        data-ad-slot="1234567890"
        data-ad-format="auto"></ins>
    </div>

    <div id="search-page">
      <div id="search-box">
        <input id="q" placeholder="搜索…" onkeydown="if(event.key==='Enter')go()">
        <button onclick="go()">搜索</button>
      </div>
      <div id="engines">
        <button class="active" onclick="setEngine(this,'https://www.google.com/search?q=')">Google</button>
        <button onclick="setEngine(this,'https://www.baidu.com/s?wd=')">百度</button>
        <button onclick="setEngine(this,'https://www.bing.com/search?q=')">Bing</button>
      </div>
    </div>

    <div id="content"></div>
  </div>
</div>

<script>
/* ======== 最终升级 JS（功能完全对齐原版） ======== */

const API='/api/data';
const DEF_ICON='/icons/gray.png';
let engine='https://www.google.com/search?q=';
let xmlDoc;

const sidebar=document.getElementById('sidebar');
const categoryCache=new Map();

fetch(API).then(r=>r.text()).then(t=>{
  requestIdleCallback(()=>{
    xmlDoc=new DOMParser().parseFromString(t,'text/xml');
    renderCats();
    backToSearch();
  });
});

function renderCats(){
  const box=document.getElementById('cats');
  const frag=document.createDocumentFragment();
  [...xmlDoc.querySelectorAll('category')].forEach((c,idx)=>{
    const d=document.createElement('div');
    d.className='cat';
    d.textContent=c.getAttribute('name');
    d.onclick=()=>{
      document.querySelectorAll('.cat').forEach(x=>x.classList.remove('active'));
      d.classList.add('active');
      loadCategory(idx);
    };
    frag.appendChild(d);
  });
  box.appendChild(frag);
}

function loadCategory(idx){
  if(categoryCache.has(idx)){
    showCategory(categoryCache.get(idx));
    return;
  }
  requestIdleCallback(()=>{
    const node=xmlDoc.querySelectorAll('category')[idx];
    const data={
      name:node.getAttribute('name'),
      subs:[...node.querySelectorAll('subcategory')].map(s=>({
        name:s.getAttribute('name'),
        links:[...s.querySelectorAll('link')].map(l=>({
          name:l.getAttribute('name'),
          url:l.getAttribute('url'),
          desc:l.getAttribute('desc'),
          icon:l.getAttribute('icon')
        }))
      }))
    };
    categoryCache.set(idx,data);
    showCategory(data);
  });
}

function showCategory(c){
  document.getElementById('search-page').style.display='none';
  const cont=document.getElementById('content');
  cont.style.display='block';
  cont.innerHTML='';

  const frag=document.createDocumentFragment();
  const title=document.createElement('div');
  title.className='category-title';
  title.textContent=c.name;
  frag.appendChild(title);

  c.subs.forEach(s=>{
    if(!s.links.length) return;
    const st=document.createElement('div');
    st.className='sub-title';
    st.textContent=s.name;
    frag.appendChild(st);

    const box=document.createElement('div');
    box.className='links';
    frag.appendChild(box);
    renderLinksBatch(box,s.links);
  });

  cont.appendChild(frag);
  document.getElementById('logo').classList.add('return-mode');
  closeSidebarOnMobile();
}

function renderLinksBatch(box,links){
  let i=0;
  const io=new IntersectionObserver(es=>{
    es.forEach(e=>{
      if(e.isIntersecting){
        const img=e.target;
        img.src=img.dataset.src;
        io.unobserve(img);
      }
    });
  });

  function run(){
    const frag=document.createDocumentFragment();
    for(let n=0;n<20 && i<links.length;n++,i++){
      const l=links[i];
      const a=document.createElement('a');
      a.className='card';
      a.href=l.url;
      a.target='_blank';

      const img=document.createElement('img');
      img.src=DEF_ICON;
      img.dataset.src=l.icon||`https://www.google.com/s2/favicons?sz=64&domain=${new URL(l.url).hostname}`;
      io.observe(img);

      const t=document.createElement('div');
      t.className='text';
      t.innerHTML=`<div class="name">${l.name}</div><div class="desc">${l.desc||''}</div>`;

      a.append(img,t);
      frag.appendChild(a);
    }
    box.appendChild(frag);
    if(i<links.length) requestAnimationFrame(run);
  }
  run();
}

function toggleSidebar(){
  sidebar.classList.toggle('visible');
  document.body.classList.toggle('sidebar-open');
}
function closeSidebarOnMobile(){
  if(window.innerWidth<=768){
    sidebar.classList.remove('visible');
    document.body.classList.remove('sidebar-open');
  }
}
function backToSearch(){
  document.getElementById('content').style.display='none';
  document.getElementById('search-page').style.display='flex';
  document.getElementById('logo').classList.remove('return-mode');
  document.querySelectorAll('.cat').forEach(x=>x.classList.remove('active'));
  closeSidebarOnMobile();
}
function go(){
  const q=document.getElementById('q').value.trim();
  if(q) window.open(engine+encodeURIComponent(q),'_blank');
}
function setEngine(b,u){
  engine=u;
  document.querySelectorAll('#engines button').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
}
function loadExternal(u){
  document.getElementById('search-page').style.display='none';
  const c=document.getElementById('content');
  c.style.display='flex';
  c.innerHTML=`<iframe src="${u}"></iframe>`;
  document.getElementById('logo').classList.add('return-mode');
  closeSidebarOnMobile();
}
</script>
</body>
</html>

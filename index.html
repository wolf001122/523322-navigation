<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>导航</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<script async
  src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9474229114991789"
  crossorigin="anonymous"></script>
<style>
/* ===== 样式：原样完整保留 ===== */
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
  background:#f8f9fa;
  color:#202124;
  height:100vh;
  overflow:hidden;
}
#layout{display:flex;height:100vh;width:100vw;}
/* ……（中间样式全部保持不变，与你原码一致）…… */
</style>
</head>
<body>
<div id="layout">
  <!-- ===== HTML 结构：与你原码完全一致 ===== -->
</div>

<script>
const API='/api/data';
let engine='https://www.google.com/search?q=';
let data;
const DEF_ICON='/icons/gray.png';
const sidebar = document.getElementById('sidebar');

function getDomain(url){
  try{ 
    const hostname=new URL(url).hostname; 
    return hostname.startsWith('www.')?hostname.slice(4):hostname; 
  }
  catch(e){ return 'example.com'; }
}

/* ===== favicon 补齐开始（新增，不影响原逻辑） ===== */

// 默认按“非大陆”处理，失败不阻塞页面
let IS_CN = false;

// 异步判断 IP（不影响首屏）
fetch('https://ipapi.co/json/')
  .then(r=>r.json())
  .then(d=>{
    if(d && (d.country === 'CN' || d.country_code === 'CN')){
      IS_CN = true;
    }
  })
  .catch(()=>{});

// favicon 统一出口函数
function getFaviconURL(domain){
  if(IS_CN){
    // 大陆可访问的 Google favicon 镜像
    return 'https://gstatic.loli.net/favicon.ico?domain=' + domain;
  }
  // 非大陆，使用原 Google favicon
  return 'https://www.google.com/s2/favicons?sz=64&domain=' + domain;
}

/* ===== favicon 补齐结束 ===== */

fetch(API).then(r=>r.text()).then(t=>{
  const xml=new DOMParser().parseFromString(t,'text/xml');
  data=[...xml.querySelectorAll('category')].map(c=>({
    name:c.getAttribute('name'),
    subs:[...c.querySelectorAll('subcategory')].map(s=>({
      name:s.getAttribute('name'),
      links:[...s.querySelectorAll('link')].map(l=>({
        name:l.getAttribute('name'),
        url:l.getAttribute('url'),
        desc:l.getAttribute('desc'),
        icon:l.getAttribute('icon')
      }))
    }))
  }));
  renderCats();
  backToSearch();
});

function renderCats(){
  const box=document.getElementById('cats'); 
  box.innerHTML='';
  data.forEach(c=>{
    const d=document.createElement('div');
    d.className='cat';
    d.textContent=c.name;
    d.onclick=()=>showCategory(c);
    box.appendChild(d);
  });
}

function showCategory(c){
  document.getElementById('search-page').style.display='none';
  const cont=document.getElementById('content');
  cont.innerHTML=''; 
  cont.style.display='block';

  c.subs.forEach((s,i)=>{
    if(!s.links.length) return;
    const box=document.createElement('div');
    box.className='links';

    s.links.forEach(l=>{
      const a=document.createElement('a');
      a.className='card';
      a.href=l.url;
      a.target='_blank';

      const img=document.createElement('img');
      if(l.icon && l.icon.trim()){
        img.src=l.icon.trim();
      }else{
        /* ★ 唯一替换点：favicon 来源 */
        img.src = getFaviconURL(getDomain(l.url));
      }
      img.onerror=()=>{ img.onerror=null; img.src=DEF_ICON; };

      const t=document.createElement('div');
      t.className='text';
      t.innerHTML=`<div class="name">${l.name}</div><div class="desc">${l.desc||''}</div>`;

      a.appendChild(img);
      a.appendChild(t);
      box.appendChild(a);
    });

    cont.appendChild(box);
  });
}

/* ===== 其余函数：go / setEngine / backToSearch / loadExternal / toggleSidebar / closeSidebarOnMobile
   与你原码完全一致，未做任何改动 ===== */
</script>
</body>
</html>

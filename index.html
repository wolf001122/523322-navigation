<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <!-- 页面元信息：设置编码和视口适配，确保移动端友好 -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>网址导航 - 资源站</title>
  <!-- 引入共用样式文件 -->
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- 头部区域：显示标题和管理员登录链接 -->
  <header>
    <h1>网址导航 <small>— 实用资源站</small></h1>
    <p style="text-align:center;margin:20px;">
      <a href="/admin/" style="color:#64748b;font-size:0.9em;">管理员登录</a>
    </p>
    <!-- 搜索输入框：支持实时过滤链接 -->
    <input type="text" id="searchInput" placeholder="搜索链接..." style="width:300px;padding:8px;margin:10px auto;display:block;">
  </header>
  <!-- 主内容容器：用于动态渲染导航分类和链接 -->
  <main id="navContainer"></main>
  <!-- 页脚：显示版权信息 -->
  <footer>© 2025 网址导航站</footer>

  <script>
    // 异步加载数据函数：从 KV 通过 Functions 代理获取 XML 数据
    async function loadData() {
      // 发送 GET 请求到 /api/data 端点
      const res = await fetch('/api/data');
      const xml = await res.text();
      // 使用 DOMParser 解析 XML 字符串为 DOM 对象
      const parser = new DOMParser();
      const doc = parser.parseFromString(xml, 'text/xml');
      // 获取所有 category 节点（分类）
      const categories = Array.from(doc.querySelectorAll('category'));
      // 获取主容器元素
      const container = document.getElementById('navContainer');
      container.innerHTML = ''; // 清空容器以防重复渲染
      
      // 遍历每个分类，渲染到页面
      categories.forEach(cat => {
        const name = cat.getAttribute('name'); // 获取分类名称
        const div = document.createElement('div'); // 创建分类容器 div
        div.className = 'category';
        div.innerHTML = `<h2>${name}</h2><ul class="link-list"></ul>`;
        const ul = div.querySelector('.link-list'); // 获取链接列表 ul
        
        // 遍历分类下的每个链接，创建 li 元素
        cat.querySelectorAll('link').forEach(link => {
          const a = document.createElement('a'); // 创建超链接 a 标签
          a.href = link.getAttribute('url'); // 设置 URL
          a.target = '_blank'; // 新标签页打开
          a.textContent = link.getAttribute('name'); // 设置链接文本
          const li = document.createElement('li'); // 创建列表项 li
          li.appendChild(a);
          // 如果有描述属性，添加描述 span
          if (link.getAttribute('desc')) {
            const span = document.createElement('span');
            span.className = 'desc';
            span.textContent = link.getAttribute('desc');
            li.appendChild(span);
          }
          ul.appendChild(li); // 将 li 添加到 ul
        });
        
        container.appendChild(div); // 将分类 div 添加到容器
      });
      
      // 绑定搜索事件：实时过滤链接
      document.getElementById('searchInput').oninput = (e) => {
        const term = e.target.value.toLowerCase(); // 获取搜索关键词（转换为小写）
        // 遍历所有 li，根据文本内容匹配显示/隐藏
        Array.from(container.querySelectorAll('.link-list li')).forEach(li => {
          li.style.display = li.textContent.toLowerCase().includes(term) ? 'flex' : 'none';
        });
      };
    }
    // 页面加载时调用加载数据
    loadData();
  </script>
</body>
</html>
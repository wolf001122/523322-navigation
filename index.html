<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>导航</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<meta name="google-adsense-account" content="ca-pub-9474229114991789">
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<script async
  src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9474229114991789"
  crossorigin="anonymous"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
  background:#f8f9fa;
  color:#202124;
  height:100vh;
  overflow:hidden;
}
#layout{display:flex;height:100vh;width:100vw}
/* 左侧分类 */
#sidebar{width:240px;background:#fff;border-right:1px solid #dadce0;display:flex;flex-direction:column;box-shadow:0 1px 2px 0 rgba(60,64,67,0.3),0 1px 3px 1px rgba(60,64,67,0.15);}
#logo{padding:24px 20px;font-size:24px;font-weight:700;text-align:center;color:#5f6368;border-bottom:1px solid #dadce0;}
#cats{flex:1;overflow-y:auto;padding:8px 0;}
.cat{padding:14px 24px;cursor:pointer;font-size:15px;color:#3c4043;transition:background 0.2s;}
.cat:hover{background:#f1f3f4;}
.cat.active{background:#e8f0fe;color:#1a73e8;font-weight:500;}
#side-bottom{border-top:1px solid #dadce0;padding:16px 24px;font-size:14px;color:#5f6368;}
#side-bottom div{margin-bottom:8px;cursor:pointer;}
#side-bottom div:hover{color:#1a73e8;}
/* 主区域 */
#main{flex:1;overflow-y:auto;background:#f8f9fa;}
#ad-top{background:#fff;border-bottom:1px solid #dadce0;padding:12px;text-align:center;box-shadow:0 1px 2px 0 rgba(60,64,67,0.3);}
/* 搜索页 */
#search-page{height:calc(100vh - 60px);display:flex;flex-direction:column;justify-content:center;align-items:center;padding:40px;}
#search-box{display:flex;width:100%;max-width:680px;}
#search-box input{flex:1;padding:16px 20px;font-size:18px;border:1px solid #dadce0;border-radius:28px 0 0 28px;outline:none;box-shadow:0 1px 6px rgba(32,33,36,0.28);transition:box-shadow 0.2s;}
#search-box input:focus{box-shadow:0 1px 6px rgba(32,33,36,0.38);}
#search-box button{padding:0 24px;border:1px solid #dadce0;border-left:none;border-radius:0 28px 28px 0;background:#1a73e8;color:#fff;cursor:pointer;}
#engines{margin-top:20px;display:flex;justify-content:center;gap:12px;flex-wrap:wrap;}
#engines button{padding:10px 20px;border:1px solid #dadce0;background:#fff;border-radius:24px;cursor:pointer;font-size:14px;color:#3c4043;transition:all 0.2s;}
#engines button:hover{background:#f1f3f4;box-shadow:0 1px 3px rgba(0,0,0,0.15);}
#engines button.active{background:#e8f0fe;color:#1a73e8;}
/* 内容页 */
#content{padding:24px;display:none;}
.back{margin-bottom:16px;color:#1a73e8;cursor:pointer;font-size:15px;display:inline-block;}
.back:hover{text-decoration:underline;}
/* 广告位 */
.ad-box{margin:32px 0;padding:16px;background:#fff;border:1px solid #dadce0;border-radius:8px;text-align:center;box-shadow:0 1px 2px 0 rgba(60,64,67,0.3);}
/* 分类卡片 */
.category-title{font-size:28px;font-weight:500;color:#202124;margin-bottom:8px;}
.sub-title{font-size:18px;color:#5f6368;margin:24px 0 12px;font-weight:500;}
.links{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;}
.card{display:flex;align-items:center;padding:16px;background:#fff;border-radius:12px;text-decoration:none;color:inherit;box-shadow:0 1px 2px 0 rgba(60,64,67,0.3),0 2px 6px 2px rgba(60,64,67,0.15);transition:all 0.2s;height:96px;}
.card:hover{box-shadow:0 4px 8px 0 rgba(60,64,67,0.3),0 8px 20px 4px rgba(60,64,67,0.15);transform:translateY(-2px);}
.card img{width:48px;height:48px;min-width:48px;min-height:48px;object-fit:contain;background:#f8f9fa;border-radius:8px;padding:4px;}
.text{margin-left:16px;overflow:hidden;}
.name{font-size:15px;font-weight:500;color:#202124;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.desc{font-size:13px;color:#5f6368;white-space:normal;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;margin-top:4px;}
/* 提交表单 */
form input, form select, form textarea{width:100%;margin:8px 0;padding:8px;}
form button{padding:10px 20px;background:#1a73e8;color:#fff;border:none;cursor:pointer;}
#captchaQuestion{font-weight:bold;margin:10px 0;color:#1a73e8;}
</style>
</head>
<body>
<div id="layout">
  <div id="sidebar">
    <div id="logo">导　航</div>
    <div id="cats"></div>
    <div id="side-bottom">
      <div onclick="showSubmit()">网站提交</div>
      <div onclick="showLinks()">友情链接</div>
      <div onclick="showAbout()">关于导航</div>
    </div>
  </div>
  <div id="main">
    <div id="ad-top">
      <ins class="adsbygoogle" style="display:block"
        data-ad-client="ca-pub-9474229114991789"
        data-ad-slot="1234567890"
        data-ad-format="auto"></ins>
    </div>
    <div id="search-page">
      <div id="search-box">
        <input id="q" placeholder="搜索…" onkeydown="if(event.key==='Enter')go()">
        <button onclick="go()">搜索</button>
      </div>
      <div id="engines">
        <button class="active" onclick="setEngine(this,'https://www.google.com/search?q=')">Google</button>
        <button onclick="setEngine(this,'https://www.baidu.com/s?wd=')">百度</button>
        <button onclick="setEngine(this,'https://www.bing.com/search?q=')">Bing</button>
      </div>
    </div>
    <div id="content"></div>
  </div>
</div>
<script>
const API='/api/data';
let engine='https://www.google.com/search?q=';
let data;
const DEF_ICON='/icons/gray.png';

// 提取域名函数
function getDomain(url) {
  try {
    const hostname = new URL(url).hostname;
    return hostname.startsWith('www.') ? hostname.slice(4) : hostname;
  } catch (e) {
    return 'example.com';
  }
}

/* ================= 分类数据 ================= */
fetch(API).then(r=>r.text()).then(t=>{
  const xml=new DOMParser().parseFromString(t,'text/xml');
  data=[...xml.querySelectorAll('category')].map(c=>({
    name:c.getAttribute('name'),
    subs:[...c.querySelectorAll('subcategory')].map(s=>({
      name:s.getAttribute('name'),
      links:[...s.querySelectorAll('link')].map(l=>({
        name:l.getAttribute('name'),
        url:l.getAttribute('url'),
        desc:l.getAttribute('desc'),
        icon:l.getAttribute('icon')
      }))
    }))
  }));
  renderCats();
});

/* ================= 渲染分类 ================= */
function renderCats(){
  const box=document.getElementById('cats'); box.innerHTML='';
  data.forEach(c=>{
    const d=document.createElement('div');
    d.className='cat'; d.textContent=c.name;
    d.onclick=()=>showCategory(c);
    box.appendChild(d);
  });
}

/* ================= 搜索 ================= */
function go(){
  const q=document.getElementById('q').value.trim();
  if(q) window.open(engine+encodeURIComponent(q),'_blank');
}
function setEngine(btn,url){
  engine=url;
  document.querySelectorAll('#engines button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}

/* ================= 分类页显示 + 图标逻辑 ================= */
function showCategory(c){
  document.getElementById('search-page').style.display='none';
  const cont=document.getElementById('content'); cont.style.display='block';
  cont.innerHTML=`<div class="back" onclick="back()">← 返回搜索</div>
    <div class="category-title">${c.name}</div>
    <div class="ad-box">
      <ins class="adsbygoogle" style="display:block"
        data-ad-client="ca-pub-9474229114991789"
        data-ad-slot="9876543210"
        data-ad-format="auto"></ins>
    </div>
  `;
  (adsbygoogle=window.adsbygoogle||[]).push({});
  c.subs.forEach((s,i)=>{
    if(!s.links.length) return;
    cont.innerHTML+=`<div class="sub-title">${s.name}</div><div class="links" id="l${i}"></div>`;
    const box=document.getElementById('l'+i);
    s.links.forEach(l=>{
      const a=document.createElement('a'); a.className='card'; a.href=l.url; a.target='_blank';
      const img=document.createElement('img');
      if (l.icon && l.icon.trim()) {
        img.src = l.icon.trim();
      } else {
        const domain = getDomain(l.url);
        img.src = `https://www.google.com/s2/favicons?sz=64&domain=${domain}`;
      }
      img.onerror = () => {
        img.onerror = null;
        img.src = DEF_ICON;
      };
      const t=document.createElement('div'); t.className='text';
      t.innerHTML=`<div class="name">${l.name}</div><div class="desc">${l.desc||''}</div>`;
      a.appendChild(img); a.appendChild(t); box.appendChild(a);
    });
    if(i===0){
      cont.innerHTML+=`<div class="ad-box">
        <ins class="adsbygoogle" style="display:block"
          data-ad-client="ca-pub-9474229114991789"
          data-ad-slot="1122334455"
          data-ad-format="auto"></ins></div>`;
      (adsbygoogle=window.adsbygoogle||[]).push({});
    }
  });
}

function back(){
  document.getElementById('content').style.display='none';
  document.getElementById('search-page').style.display='flex';
}

/* ================= 网站提交 + 验证码 + 重复域名检查 ================= */
function showSubmit(){
  showPage(`
    <h2>网站提交</h2>
    <form onsubmit="submitSite(event)">
      <select id="c1" required></select>
      <select id="c2" required></select>
      <input id="name" placeholder="网站名称" required>
      <input id="url" placeholder="https://example.com" required>
      <textarea id="desc" placeholder="网站简介" required></textarea>
      <input id="hp" style="display:none" autocomplete="off" readonly>
      <div id="captchaQuestion" style="margin:10px 0;font-weight:bold;color:#1a73e8;"></div>
      <input id="captchaAnswer" placeholder="请输入答案" required style="width:100%;padding:8px;margin:4px 0;">
      <button>提交</button>
    </form>
    <p id="msg"></p>
  `);

  // 定义全局变量
  window.c1 = document.getElementById('c1');
  window.c2 = document.getElementById('c2');
  window.nameInput = document.getElementById('name');
  window.urlInput = document.getElementById('url');
  window.descInput = document.getElementById('desc');
  window.hp = document.getElementById('hp');
  window.msg = document.getElementById('msg');
  window.captchaQuestion = document.getElementById('captchaQuestion');
  window.captchaAnswer = document.getElementById('captchaAnswer');

  initCats();
  generateCaptcha();
}

function generateCaptcha() {
  const a = Math.floor(Math.random() * 10) + 1;
  const b = Math.floor(Math.random() * 10) + 1;
  const operators = ['+', '-', '×'];
  const op = operators[Math.floor(Math.random() * operators.length)];
  let question, answer;

  switch (op) {
    case '+': question = `${a} + ${b} = ?`; answer = a + b; break;
    case '-': question = `${a} - ${b} = ?`; answer = a - b; break;
    case '×': question = `${a} × ${b} = ?`; answer = a * b; break;
  }

  captchaQuestion.textContent = `验证码：${question}`;
  window.correctAnswer = answer;
}

function initCats(){
  c1.innerHTML = '<option value="">请选择一级分类</option>';
  data.forEach((cat, i) => {
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = cat.name;
    c1.appendChild(opt);
  });

  c1.onchange = () => {
    c2.innerHTML = '<option value="">请选择二级分类</option>';
    if (c1.value !== '') {
      data[c1.value].subs.forEach(sub => {
        const opt = document.createElement('option');
        opt.textContent = sub.name;
        c2.appendChild(opt);
      });
    }
  };
}

function submitSite(e){
  e.preventDefault();

  if (hp && hp.value !== '') {
    msg.textContent = '异常操作，已阻止';
    return;
  }

  const userAnswer = parseInt(captchaAnswer.value.trim(), 10);
  if (isNaN(userAnswer) || userAnswer !== window.correctAnswer) {
    msg.textContent = '验证码错误，请重新计算';
    generateCaptcha();
    captchaAnswer.value = '';
    return;
  }

  const submittedUrl = urlInput.value.trim();
  if (!submittedUrl) {
    msg.textContent = '请填写网站URL';
    return;
  }

  // 检查一级域名重复
  let submittedRoot = '';
  try {
    let hostname = new URL(submittedUrl).hostname.toLowerCase();
    if (hostname.startsWith('www.')) hostname = hostname.slice(4);
    const parts = hostname.split('.');
    if (parts.length <= 2) {
      submittedRoot = hostname;
    } else {
      const last = parts[parts.length - 1];
      const secondLast = parts[parts.length - 2];
      const countrySuffixes = ['cn', 'uk', 'jp', 'de', 'fr', 'au', 'br', 'ru', 'in', 'ca', 'it', 'es', 'nl', 'kr', 'tw', 'hk', 'sg'];
      const publicSuffixes = ['com', 'net', 'org', 'gov', 'edu', 'co', 'ne', 'or', 'go', 'ac', 'mil', 'info', 'biz'];
      if (countrySuffixes.includes(last) && publicSuffixes.includes(secondLast) && parts.length >= 3) {
        submittedRoot = parts.slice(-3).join('.');
      } else {
        submittedRoot = parts.slice(-2).join('.');
      }
    }
  } catch {
    msg.textContent = 'URL格式不正确';
    return;
  }

  fetch(API)
    .then(r => r.text())
    .then(text => {
      const parser = new DOMParser();
      const doc = parser.parseFromString(text, 'text/xml');
      const existingRootDomains = new Set();
      doc.querySelectorAll('link').forEach(link => {
        let url = link.getAttribute('url');
        if (url) {
          try {
            let hostname = new URL(url).hostname.toLowerCase();
            if (hostname.startsWith('www.')) hostname = hostname.slice(4);
            const parts = hostname.split('.');
            let root = '';
            if (parts.length <= 2) {
              root = hostname;
            } else {
              const last = parts[parts.length - 1];
              const secondLast = parts[parts.length - 2];
              const countrySuffixes = ['cn', 'uk', 'jp', 'de', 'fr', 'au', 'br', 'ru', 'in', 'ca', 'it', 'es', 'nl', 'kr', 'tw', 'hk', 'sg'];
              const publicSuffixes = ['com', 'net', 'org', 'gov', 'edu', 'co', 'ne', 'or', 'go', 'ac', 'mil', 'info', 'biz'];
              if (countrySuffixes.includes(last) && publicSuffixes.includes(secondLast) && parts.length >= 3) {
                root = parts.slice(-3).join('.');
              } else {
                root = parts.slice(-2).join('.');
              }
            }
            if (root) existingRootDomains.add(root);
          } catch {}
        }
      });

      if (existingRootDomains.has(submittedRoot)) {
        alert('此一级域名已存在（包括二级域名如 pan.baidu.com 等），请勿重复提交！');
        msg.textContent = '重复域名，提交已阻止';
        generateCaptcha();
        return;
      }

      const site = {
        cat1: c1.options[c1.selectedIndex]?.text || '',
        cat2: c2.options[c2.selectedIndex]?.text || '',
        name: nameInput.value.trim(),
        url: submittedUrl,
        desc: descInput.value.trim()
      };

      if (!site.cat1 || !site.cat2 || !site.name || !site.url || !site.desc) {
        msg.textContent = '请填写完整信息并选择分类';
        generateCaptcha();
        return;
      }

      msg.textContent = '提交中...';

      fetch('/api/submit', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(site)
      })
      .then(r => r.text())
      .then(text => {
        if (text.includes('成功')) {
          msg.textContent = '提交成功，等待管理员审核';
          e.target.reset();
          generateCaptcha();
          c1.selectedIndex = 0;
          c2.innerHTML = '<option value="">请选择二级分类</option>';
        } else {
          msg.textContent = '提交失败：' + text;
          generateCaptcha();
        }
      })
      .catch(() => {
        msg.textContent = '网络错误，请重试';
        generateCaptcha();
      });
    })
    .catch(() => {
      msg.textContent = '检查重复时出错，请重试';
      generateCaptcha();
    });
}

/* ================= 友情链接 ================= */
function showLinks(){
  showPage(`<h2>友情链接</h2><div class="links">
    <div class="card"><div class="text"><div class="name">虚位以待</div><div class="desc">欢迎交换友情链接</div></div></div>
  </div>`);
}

/* ================= 关于导航 ================= */
function showAbout(){
  showPage(`<h2>关于导航</h2>
    <p>本站致力于收录优质、常用的网站资源。</p>
    <p>所有网站均来源于人工整理与用户提交，经审核后上线。</p>
    <p>如发现不良内容，可联系我们处理。</p>
  `);
}

/* ================= 公共显示 ================= */
function showPage(html){
  document.getElementById('search-page').style.display='none';
  const c=document.getElementById('content'); c.style.display='block'; c.innerHTML=html;
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>反馈管理</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
  margin:0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background:#f8fafc;
  color:#0f172a;
}
.header{
  padding:16px 24px;
  font-size:20px;
  font-weight:600;
  border-bottom:1px solid #e5e7eb;
}
.container{
  padding:24px;
}
.table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
}
.table th,.table td{
  border:1px solid #e5e7eb;
  padding:12px;
  text-align:left;
  vertical-align:top;
}
.table th{
  background:#f1f5f9;
  font-weight:600;
}
.actions button{
  margin-right:8px;
  padding:6px 12px;
  border:none;
  border-radius:4px;
  cursor:pointer;
}
.reply-btn{background:#3b82f6;color:#fff;}
.delete-btn{background:#ef4444;color:#fff;}

.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  display:none;
  align-items:center;
  justify-content:center;
}
.modal-content{
  background:#fff;
  width:520px;
  max-width:95%;
  border-radius:8px;
  padding:20px;
}
.modal h3{
  margin-top:0;
}
.modal input,.modal textarea{
  width:100%;
  padding:10px;
  margin-bottom:12px;
  border:1px solid #cbd5f5;
  border-radius:4px;
}
.modal textarea{resize:none;height:120px;}
.modal-actions{text-align:right;}
.modal-actions button{
  padding:8px 16px;
  border:none;
  border-radius:4px;
  cursor:pointer;
}
.send-btn{background:#22c55e;color:#fff;}
.cancel-btn{background:#64748b;color:#fff;margin-right:8px;}
</style>
</head>
<body>

<div class="header">反馈管理</div>
<div class="container">
  <table class="table">
    <thead>
      <tr>
        <th width="60">编号</th>
        <th width="160">时间</th>
        <th>反馈内容</th>
        <th width="180">联系方式</th>
        <th width="140">操作</th>
      </tr>
    </thead>
    <tbody id="list"></tbody>
  </table>
</div>

<!-- 回复弹窗 -->
<div class="modal" id="replyModal">
  <div class="modal-content">
    <h3>回复用户反馈</h3>
    <input id="mailTo" disabled>
    <input id="mailSubject">
    <textarea id="mailContent" placeholder="请输入回复内容…"></textarea>
    <div class="modal-actions">
      <button class="cancel-btn" onclick="closeModal()">取消</button>
      <button class="send-btn" onclick="sendReply()">发送回复</button>
    </div>
  </div>
</div>

<script>
let feedbackList=[];
let currentIndex=-1;

async function loadFeedback(){
  const res=await fetch('/api/admin/feedback');
  feedbackList=await res.json();
  const tbody=document.getElementById('list');
  tbody.innerHTML='';
  feedbackList.forEach((f,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>#${i+1}</td>
      <td>${new Date(f.time).toLocaleString()}</td>
      <td>${f.message}</td>
      <td>${f.contact||'-'}</td>
      <td class="actions">
        ${isEmail(f.contact)?`<button class="reply-btn" onclick="openReply(${i})">回复</button>`:''}
        <button class="delete-btn" onclick="remove(${i})">删除</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function isEmail(v){
  return /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(v||'');
}

function openReply(i){
  currentIndex=i;
  const f=feedbackList[i];
  document.getElementById('mailTo').value=f.contact;
  const date=new Date(f.time).toISOString().slice(0,10);
  document.getElementById('mailSubject').value=
    `【导航站反馈回复｜${date}｜#${Date.parse(f.time)}】`;
  document.getElementById('mailContent').value='';
  document.getElementById('replyModal').style.display='flex';
}

function closeModal(){
  document.getElementById('replyModal').style.display='none';
}

async function sendReply(){
  const subject=document.getElementById('mailSubject').value.trim();
  const content=document.getElementById('mailContent').value.trim();
  if(!subject||!content){
    alert('主题和回复内容不能为空');
    return;
  }
  alert('✅ 模拟发送成功（后续接入 Gmail / GAS）');
  closeModal();
}

async function remove(i){
  if(!confirm('确认删除该反馈？')) return;
  await fetch('/api/admin/feedback/delete',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({index:i})
  });
  loadFeedback();
}

loadFeedback();
</script>

</body>
</html>

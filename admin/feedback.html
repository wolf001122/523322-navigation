<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>用户反馈管理</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
  background:#f8f9fa;
  color:#202124;
  padding:20px;
}
h1{
  font-size:24px;
  margin-bottom:20px;
  text-align:center;
}
#list{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(320px,1fr));
  gap:16px;
}
.card{
  background:#fff;
  border-radius:12px;
  padding:16px;
  box-shadow:0 1px 2px rgba(60,64,67,.3),0 2px 6px rgba(60,64,67,.15);
  display:flex;
  flex-direction:column;
}
.card p{
  margin:6px 0;
  word-break:break-word;
}
.label{
  font-weight:500;
  color:#5f6368;
}
.time{
  font-size:13px;
  color:#80868b;
}
.actions{
  margin-top:12px;
}
button{
  padding:8px 14px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-size:14px;
  margin-right:6px;
}
.reply{
  background:#1a73e8;
  color:#fff;
}
.delete{
  background:#d93025;
  color:#fff;
}
.reply:disabled{
  background:#9aa0a6;
  cursor:not-allowed;
}
#msg{
  text-align:center;
  margin:16px 0;
  color:#d93025;
}
/* 回复弹窗 */
#modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  align-items:center;
  justify-content:center;
  z-index:100;
}
.modal-box{
  background:#fff;
  width:90%;
  max-width:480px;
  border-radius:12px;
  padding:20px;
}
.modal-box h2{
  margin-bottom:12px;
  font-size:20px;
}
.modal-box input, .modal-box textarea{
  width:100%;
  padding:10px;
  border:1px solid #dadce0;
  border-radius:6px;
  margin-bottom:12px;
  font-size:14px;
}
.modal-box textarea{
  height:120px;
  resize:none;
}
.modal-actions{
  text-align:right;
}
.modal-actions button{
  margin-left:8px;
}
</style>
</head>
<body>
<h1>用户反馈管理</h1>
<div id="list">加载中...</div>
<div id="msg"></div>
<!-- 回复弹窗 -->
<div id="modal">
  <div class="modal-box">
    <h2>回复用户反馈</h2>
    <p id="replyTo" class="time"></p>
    <input id="replySubject" placeholder="邮件主题（可修改）">
    <textarea id="replyText" placeholder="请输入回复内容..."></textarea>
    <div class="modal-actions">
      <button onclick="closeModal()">取消</button>
      <button class="reply" onclick="sendReply()">发送</button>
    </div>
  </div>
</div>
<script>
let feedbackList = [];
let currentEmail = '';
let currentIndex = -1;
// 您的 GAS Web App URL（替换为您的部署 URL）
const GAS_URL = 'https://script.google.com/macros/library/d/1BNqMV8XJldHozGOsvzkUSCT4mJhyMuNpz9OAWJAin0HMQK79R-ts8pc8/8'; // ← 替换为您的 GAS URL
async function loadFeedback(){
  try{
    const res = await fetch('/api/feedback/list');
    feedbackList = await res.json();
    const box = document.getElementById('list');
    if(!feedbackList.length){
      box.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:#5f6368;">暂无用户反馈</p>';
      return;
    }
    box.innerHTML = '';
    feedbackList.forEach((f, i)=>{
      const card = document.createElement('div');
      card.className = 'card';
      const hasEmail = f.contact && f.contact.includes('@');
      card.innerHTML = `
        <p><span class="label">反馈内容：</span>${escapeHtml(f.message)}</p>
        <p><span class="label">联系方式：</span>${f.contact || '未填写'}</p>
        <p class="time">提交时间：${new Date(f.time).toLocaleString()}</p>
        <div class="actions">
          <button class="reply" ${hasEmail?'':'disabled'} onclick="openReply(${i})">邮件回复</button>
          <button class="delete" onclick="removeFeedback(${i})">删除</button>
        </div>
      `;
      box.appendChild(card);
    });
  }catch(e){
    document.getElementById('msg').textContent = '加载失败：'+e.message;
  }
}
function openReply(index){
  currentIndex = index;
  const f = feedbackList[index];
  currentEmail = f.contact || '';
  document.getElementById('replyTo').textContent = '收件人：'+currentEmail;
  document.getElementById('replyText').value='';
  document.getElementById('replySubject').value = `[反馈回复#${f.time ? new Date(f.time).getTime() : Date.now()}] 关于您的反馈`;
  document.getElementById('modal').style.display='flex';
}
function closeModal(){
  document.getElementById('modal').style.display='none';
}
async function sendReply(){
  const subject = document.getElementById('replySubject').value.trim();
  const text = document.getElementById('replyText').value.trim();
  if(!text){ alert('请输入回复内容'); return; }
  if(!subject){ alert('请输入邮件主题'); return; }
  if(!currentEmail){ alert('收件人邮箱为空'); return; }
  try{
    // POST 调用 GAS
    const res = await fetch(GAS_URL, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        to: currentEmail,
        subject: subject,
        message: text
      })
    });
    const result = await res.json();
    if(result.status==='success'){
      alert('✅ 邮件已发送');
      closeModal();
    } else {
      alert('❌ 发送失败：'+result.message);
    }
  }catch(err){
    alert('发送异常：'+err.message);
  }
}
async function removeFeedback(index){
  if(!confirm('确定要删除这条反馈吗？')) return;
  const res = await fetch('/api/feedback/delete',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ index })
  });
  if(res.ok){
    loadFeedback();
  }else{
    alert('删除失败');
  }
}
function escapeHtml(str){
  return str.replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));
}
loadFeedback();
</script>
</body>
</html>

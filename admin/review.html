<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>待审核网站提交</title>
<style>
body {font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; background: #f8f9fa; color: #202124;}
h1 {font-size: 24px; margin-bottom: 20px;}
.item {border: 1px solid #dadce0; margin: 15px 0; padding: 15px; border-radius: 8px; background: #fff; box-shadow: 0 1px 2px rgba(60,64,67,0.3);}
.item p {margin: 8px 0;}
button {padding: 8px 16px; margin-right: 10px; border: none; border-radius: 4px; cursor: pointer;}
.approve {background: #1a73e8; color: #fff;}
.edit {background: #34a853; color: #fff;}
.delete {background: #f44336; color: #fff;}
#msg {color: #d93025; margin-top: 20px; font-weight:500;}

/* 修改弹窗样式 */
#editModal {display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:100;}
.modal-content {background:#fff; padding:20px; border-radius:8px; width:90%; max-width:500px;}
.modal-content h2 {margin-bottom:15px;}
.modal-content input, .modal-content textarea, .modal-content select {width:100%; padding:8px; margin:8px 0;}
.modal-content button {margin-right:10px;}
</style>
</head>
<body>
<h1>待审核网站提交</h1>
<div id="list">加载中...</div>
<div id="msg"></div>

<!-- 修改弹窗 -->
<div id="editModal">
  <div class="modal-content">
    <h2>修改提交信息</h2>
    <input id="editName" placeholder="网站名称" required>
    <input id="editUrl" placeholder="https://example.com" required>
    <textarea id="editDesc" placeholder="网站简介" required></textarea>
    <p><strong>分类：</strong><span id="editCat"></span></p>
    <button class="approve" onclick="saveEdit()">保存修改</button>
    <button onclick="closeModal()">取消</button>
    <p id="editMsg"></p>
  </div>
</div>

<script>
let currentEditId = null;  // 当前正在修改的提交ID

function loadPending() {
  fetch('/api/pending')
    .then(r => {
      if (!r.ok) throw new Error('加载失败');
      return r.json();
    })
    .then(list => {
      const div = document.getElementById('list');
      if (list.length === 0) {
        div.innerHTML = '<p>暂无待审核提交</p>';
        return;
      }
      div.innerHTML = '';
      list.forEach(site => {
        const item = document.createElement('div');
        item.className = 'item';
        item.innerHTML = `
          <p><strong>网站名称：</strong>${site.name}</p>
          <p><strong>URL：</strong><a href="${site.url}" target="_blank">${site.url}</a></p>
          <p><strong>分类：</strong>${site.cat1} > ${site.cat2}</p>
          <p><strong>简介：</strong>${site.desc}</p>
          <p><strong>提交时间：</strong>${new Date(site.time).toLocaleString()}</p>
          <button class="approve" onclick="review(${site.id}, 'approve')">通过并上线</button>
          <button class="edit" onclick="openEdit(${site.id})">修改</button>
          <button class="delete" onclick="review(${site.id}, 'delete')">删除</button>
        `;
        div.appendChild(item);
      });
    })
    .catch(err => {
      document.getElementById('list').innerHTML = '<p style="color:red">加载失败：' + err.message + '</p>';
    });
}

function review(id, action) {
  if (!confirm(action === 'approve' ? '确认通过并上线此网站？' : '确认删除此提交？')) return;

  fetch('/api/approve', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({id, action})
  })
  .then(r => r.text())
  .then(msg => {
    alert(msg);
    loadPending();
  })
  .catch(err => alert('操作失败：' + err.message));
}

// 打开修改弹窗
function openEdit(id) {
  fetch('/api/pending')
    .then(r => r.json())
    .then(list => {
      const site = list.find(s => s.id === id);
      if (!site) {
        alert('未找到该提交');
        return;
      }
      currentEditId = id;
      document.getElementById('editName').value = site.name;
      document.getElementById('editUrl').value = site.url;
      document.getElementById('editDesc').value = site.desc;
      document.getElementById('editCat').textContent = site.cat1 + ' > ' + site.cat2;
      document.getElementById('editModal').style.display = 'flex';
    });
}

// 关闭弹窗
function closeModal() {
  document.getElementById('editModal').style.display = 'none';
  document.getElementById('editMsg').textContent = '';
}

// 保存修改（新增 /api/edit 接口）
function saveEdit() {
  const name = document.getElementById('editName').value.trim();
  const url = document.getElementById('editUrl').value.trim();
  const desc = document.getElementById('editDesc').value.trim();

  if (!name || !url || !desc) {
    document.getElementById('editMsg').textContent = '请填写完整';
    return;
  }

  fetch('/api/edit', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({id: currentEditId, name, url, desc})
  })
  .then(r => r.text())
  .then(msg => {
    alert(msg);
    if (msg.includes('成功')) {
      closeModal();
      loadPending();
    }
  })
  .catch(() => alert('修改失败'));
}

// 初始加载 + 自动刷新
loadPending();
setInterval(loadPending, 30000);
</script>
</body>
</html>

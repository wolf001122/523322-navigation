<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>待审核网站提交</title>
<style>
body {font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; background: #f8f9fa; color: #202124;}
h1 {font-size: 24px; margin-bottom: 20px; text-align: center;}
#list {display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;}
.item {background: #fff; border-radius: 12px; padding: 16px; box-shadow: 0 1px 2px rgba(60,64,67,0.3), 0 2px 6px 2px rgba(60,64,67,0.15);}
.item.duplicate {border: 2px solid #f44336; background: #ffebee;} /* 重复标红 */
.item p {margin: 8px 0; word-break: break-all;}
.item strong {color: #5f6368;}
.duplicate-notice {color: #d93025; font-weight: bold; margin-bottom: 10px;}
button {padding: 8px 16px; margin: 5px 5px 5px 0; border: none; border-radius: 4px; cursor: pointer;}
.approve {background: #1a73e8; color: #fff;}
.edit {background: #34a853; color: #fff;}
.delete {background: #f44336; color: #fff;}
#msg {text-align: center; margin: 20px 0; font-weight: 500; color: #d93025;}

/* 修改弹窗样式保持不变 */
#editModal {display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 100;}
.modal-content {background: #fff; padding: 24px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);}
.modal-content h2 {margin-bottom: 16px;}
.modal-content input, .modal-content textarea, .modal-content select {width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #dadce0; border-radius: 4px;}
.modal-content button {margin-right: 10px;}
</style>
</head>
<body>
<h1>待审核网站提交</h1>
<div id="list">加载中...</div>
<div id="msg"></div>

<!-- 修改弹窗（保持原有） -->
<div id="editModal">
  <div class="modal-content">
    <h2>修改提交信息</h2>
    <select id="editCat1" required></select>
    <select id="editCat2" required></select>
    <input id="editName" placeholder="网站名称" required>
    <input id="editUrl" placeholder="https://example.com" required>
    <textarea id="editDesc" placeholder="网站简介" rows="4" required></textarea>
    <button class="approve" onclick="saveEdit()">保存修改</button>
    <button onclick="closeModal()">取消</button>
    <p id="editMsg"></p>
  </div>
</div>

<script>
let currentEditId = null;
let categories = [];  // 正式分类
let existingUrls = new Set();  // 正式 XML 中所有 URL 集合（用于重复检测）

// 加载正式数据（分类 + URL 集合）
async function loadFormalData() {
  try {
    const res = await fetch('/api/data');
    const text = await res.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(text, 'text/xml');

    // 提取分类
    categories = [...doc.querySelectorAll('category')].map(c => ({
      name: c.getAttribute('name'),
      subs: [...c.querySelectorAll('subcategory')].map(s => s.getAttribute('name'))
    }));

    // 提取所有现有 URL（去重）
    existingUrls = new Set();
    doc.querySelectorAll('link').forEach(link => {
      const url = link.getAttribute('url');
      if (url) existingUrls.add(url.trim());
    });
  } catch (e) {
    console.error('加载正式数据失败', e);
  }
}

// 加载待审核列表 + 重复检测
async function loadPending() {
  await loadFormalData();  // 确保正式数据已加载

  try {
    const res = await fetch('/api/pending');
    if (!res.ok) throw new Error('加载失败');
    const list = await res.json();

    const div = document.getElementById('list');
    if (list.length === 0) {
      div.innerHTML = '<p style="grid-column: 1 / -1; text-align:center;">暂无待审核提交</p>';
      return;
    }
    div.innerHTML = '';
    list.forEach(site => {
      const isDuplicate = existingUrls.has(site.url.trim());

      const item = document.createElement('div');
      item.className = `item ${isDuplicate ? 'duplicate' : ''}`;

      item.innerHTML = `
        ${isDuplicate ? '<div class="duplicate-notice">⚠️ 此网站已存在（重复提交）</div>' : ''}
        <p><strong>网站名称：</strong>${site.name}</p>
        <p><strong>URL：</strong><a href="${site.url}" target="_blank">${site.url}</a></p>
        <p><strong>分类：</strong>${site.cat1} > ${site.cat2}</p>
        <p><strong>简介：</strong>${site.desc}</p>
        <p><strong>提交时间：</strong>${new Date(site.time).toLocaleString()}</p>
        <div style="margin-top:12px;">
          <button class="approve" onclick="review(${site.id}, 'approve')">${isDuplicate ? '仍要通过' : '通过并上线'}</button>
          <button class="edit" onclick="openEdit(${site.id})">修改</button>
          <button class="delete" onclick="review(${site.id}, 'delete')">删除</button>
        </div>
      `;
      div.appendChild(item);
    });
  } catch (err) {
    document.getElementById('list').innerHTML = '<p style="color:red; grid-column: 1 / -1; text-align:center;">加载失败：' + err.message + '</p>';
  }
}

// 其他函数（review, openEdit, fillEditCats, closeModal, saveEdit）保持不变（复制您之前的代码）

// 初始化
loadPending();
setInterval(loadPending, 30000);
</script>
</body>
</html>

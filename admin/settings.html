async function saveToKV() {
  if (!confirm('确认保存所有数据到云端 KV？')) return;

  let categories = [];
  try {
    const res = await fetch('/api/data');
    const xml = await res.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(xml, 'text/xml');
    categories = Array.from(doc.querySelectorAll('category')).map(cat => ({
      name: cat.getAttribute('name'),
      subcategories: Array.from(cat.querySelectorAll('subcategory')).map(sub => ({
        name: sub.getAttribute('name'),
        links: Array.from(sub.querySelectorAll('link')).map(l => ({
          name: l.getAttribute('name'),
          url: l.getAttribute('url'),
          desc: l.getAttribute('desc') || '',
          icon: l.getAttribute('icon') || ''
        }))
      })) || [{ name: '默认子分类', links: Array.from(cat.querySelectorAll('link')).map(l => ({
        name: l.getAttribute('name'),
        url: l.getAttribute('url'),
        desc: l.getAttribute('desc') || '',
        icon: l.getAttribute('icon') || ''
      }))} ]
    }));
  } catch (e) {
    alert('读取当前数据失败');
    return;
  }

  // 应用临时新增的链接
  if (window.tempLinks) {
    window.tempLinks.forEach(item => {
      const link = item.link;
      if (!categories[item.catIdx].subcategories[item.subIdx]) {
        categories[item.catIdx].subcategories[item.subIdx] = { name: '临时子分类', links: [] };
      }
      categories[item.catIdx].subcategories[item.subIdx].links.push(link);
    });
    window.tempLinks = []; // 清空
  }

  // 生成新 XML
  let xml = '<?xml version="1.0" encoding="UTF-8"?>\n<navigation>\n';
  const adminRes = await fetch('/api/data');
  const original = await adminRes.text();
  const adminDoc = new DOMParser().parseFromString(original, 'text/xml');
  const admin = adminDoc.querySelector('admin');
  if (admin) xml += `  <admin username="${admin.getAttribute('username')}" password="${admin.getAttribute('password')}" />\n`;

  categories.forEach(cat => {
    xml += `  <category name="${escapeXml(cat.name)}">\n`;
    cat.subcategories.forEach(sub => {
      xml += `    <subcategory name="${escapeXml(sub.name)}">\n`;
      sub.links.forEach(link => {
        const desc = link.desc ? ` desc="${escapeXml(link.desc)}"` : '';
        const icon = link.icon ? ` icon="${escapeXml(link.icon)}"` : '';
        xml += `      <link name="${escapeXml(link.name)}" url="${escapeXml(link.url)}"${desc}${icon}/>\n`;
      });
      xml += '    </subcategory>\n';
    });
    xml += '  </category>\n';
  });
  xml += '</navigation>';

  const r = await fetch('/api/save', {
    method: 'POST',
    headers: { 'Content-Type': 'text/xml' },
    body: xml
  });

  if (r.ok) {
    alert('保存成功！所有新增链接已永久写入 KV');
  } else {
    alert('保存失败：' + await r.text());
  }
}

function escapeXml(s) {
  return s.replace(/[<>&"']/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;',"'''":'&apos;'})[c]);
}

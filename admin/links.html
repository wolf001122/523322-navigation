<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>链接管理</title>
<style>
body { font-family: Arial; background:#f1f3f4; padding:24px; }
.card { background:#fff; border-radius:8px; padding:20px; box-shadow:0 1px 3px rgba(0,0,0,.1); }
h2 { margin-top:0; }
select, input, textarea { width:100%; padding:6px; margin:6px 0; }
button { padding:8px 14px; margin-right:6px; cursor:pointer; }
.list { margin-top:20px; }
.item { border-bottom:1px solid #eee; padding:10px 0; }
.item b { font-size:15px; }
.actions button { margin-top:6px; }
</style>
</head>
<body>

<div class="card">
  <h2>链接管理（基于二级分类）</h2>

  <label>一级分类</label>
  <select id="catSelect"></select>

  <label>二级分类</label>
  <select id="subSelect"></select>

  <hr>

  <h3>新增 / 编辑链接</h3>
  <input id="name" placeholder="名称">
  <input id="url" placeholder="URL">
  <input id="icon" placeholder="图标 URL（可选）">
  <textarea id="desc" placeholder="描述（可选）"></textarea>
  <button onclick="saveLink()">保存链接</button>

  <div class="list" id="linkList"></div>
</div>

<script>
let xmlDoc;
let editIndex = -1;

/* ===== 加载 XML ===== */
async function loadXML() {
  const res = await fetch('/api/data?t=' + Date.now());
  const text = await res.text();
  xmlDoc = new DOMParser().parseFromString(text, 'text/xml');
  initSelects();
}

/* ===== 初始化下拉 ===== */
function initSelects() {
  const catSelect = document.getElementById('catSelect');
  catSelect.innerHTML = '';

  xmlDoc.querySelectorAll('category').forEach((c,i)=>{
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = c.getAttribute('name');
    catSelect.appendChild(opt);
  });

  catSelect.onchange = updateSub;
  updateSub();
}

/* ===== 二级分类联动 ===== */
function updateSub() {
  const subSelect = document.getElementById('subSelect');
  subSelect.innerHTML = '';

  const cat = xmlDoc.querySelectorAll('category')[catSelect.value];
  cat.querySelectorAll('subcategory').forEach((s,i)=>{
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = s.getAttribute('name');
    subSelect.appendChild(opt);
  });

  renderList();
  subSelect.onchange = renderList;
}

/* ===== 渲染链接列表 ===== */
function renderList() {
  editIndex = -1;
  const list = document.getElementById('linkList');
  list.innerHTML = '';

  const cat = xmlDoc.querySelectorAll('category')[catSelect.value];
  const sub = cat.querySelectorAll('subcategory')[subSelect.value];
  const links = sub.querySelectorAll('link');

  links.forEach((l,i)=>{
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `
      <b>${l.getAttribute('name')}</b><br>
      <small>${l.getAttribute('url')}</small>
      <div class="actions">
        <button onclick="editLink(${i})">编辑</button>
        <button onclick="deleteLink(${i})">删除</button>
      </div>
    `;
    list.appendChild(div);
  });
}

/* ===== 编辑 ===== */
function editLink(i) {
  const cat = xmlDoc.querySelectorAll('category')[catSelect.value];
  const sub = cat.querySelectorAll('subcategory')[subSelect.value];
  const link = sub.querySelectorAll('link')[i];

  name.value = link.getAttribute('name');
  url.value = link.getAttribute('url');
  icon.value = link.getAttribute('icon') || '';
  desc.value = link.getAttribute('desc') || '';

  editIndex = i;
}

/* ===== 保存（新增 / 修改） ===== */
function saveLink() {
  const cat = xmlDoc.querySelectorAll('category')[catSelect.value];
  const sub = cat.querySelectorAll('subcategory')[subSelect.value];

  let link;
  if (editIndex >= 0) {
    link = sub.querySelectorAll('link')[editIndex];
  } else {
    link = xmlDoc.createElement('link');
    sub.appendChild(link);
  }

  link.setAttribute('name', name.value);
  link.setAttribute('url', url.value);

  desc.value ? link.setAttribute('desc', desc.value) : link.removeAttribute('desc');
  icon.value ? link.setAttribute('icon', icon.value) : link.removeAttribute('icon');

  persist();
}

/* ===== 删除 ===== */
function deleteLink(i) {
  if (!confirm('确定删除该链接？')) return;

  const cat = xmlDoc.querySelectorAll('category')[catSelect.value];
  const sub = cat.querySelectorAll('subcategory')[subSelect.value];
  sub.removeChild(sub.querySelectorAll('link')[i]);

  persist();
}

/* ===== 写入 KV ===== */
async function persist() {
  const xml = new XMLSerializer().serializeToString(xmlDoc);
  await fetch('/api/save', {
    method:'POST',
    headers:{'Content-Type':'text/xml'},
    body:xml
  });
  location.reload();
}

loadXML();
</script>

</body>
</html>

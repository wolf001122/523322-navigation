<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>链接管理</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: #f5f6f7;
}

/* ===== 顶部栏 ===== */
.topbar {
  position: sticky;
  top: 0;
  z-index: 10;
  background: #fff;
  border-bottom: 1px solid #ddd;
  padding: 10px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.status {
  font-size: 14px;
}

.status.saved { color: #2ecc71; }
.status.dirty { color: #e67e22; }

button {
  padding: 6px 12px;
  border-radius: 4px;
  border: 1px solid #409eff;
  background: #409eff;
  color: #fff;
  cursor: pointer;
}

button.secondary {
  background: #fff;
  color: #409eff;
}

button.danger {
  background: #e74c3c;
  border-color: #e74c3c;
}

/* ===== 布局 ===== */
main {
  padding: 16px;
}

.group {
  margin-bottom: 30px;
}

.group-title {
  font-size: 18px;
  margin-bottom: 10px;
  border-left: 4px solid #409eff;
  padding-left: 8px;
}

.cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  gap: 12px;
}

.card {
  background: #fff;
  border-radius: 6px;
  padding: 10px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.card .name {
  font-weight: 600;
  font-size: 14px;
}

.card .url {
  font-size: 12px;
  color: #666;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.card .actions {
  margin-top: auto;
  display: flex;
  gap: 8px;
}

/* ===== 编辑框 ===== */
.editor {
  background: #fff;
  padding: 12px;
  border-radius: 6px;
  margin-bottom: 20px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
}

.editor h3 {
  margin-top: 0;
}

.editor label {
  font-size: 13px;
  display: block;
  margin-top: 8px;
}

.editor input, .editor select {
  width: 100%;
  padding: 6px;
  margin-top: 4px;
}
</style>
</head>

<body>

<div class="topbar">
  <div id="status" class="status saved">✔ 所有更改已保存</div>
  <button onclick="saveToKV()">保存到 KV</button>
</div>

<main>

  <!-- 编辑区 -->
  <div class="editor">
    <h3>编辑 / 新增链接</h3>

    <label>一级分类</label>
    <select id="cat1"></select>

    <label>二级分类</label>
    <select id="cat2"></select>

    <label>网站名称</label>
    <input id="name">

    <label>网址</label>
    <input id="url">

    <label>描述</label>
    <input id="desc">

    <div style="margin-top:10px;display:flex;gap:10px">
      <button onclick="applyEdit()">应用修改</button>
      <button class="secondary" onclick="resetEditor()">清空</button>
    </div>
  </div>

  <!-- 列表 -->
  <div id="list"></div>

</main>

<script>
let nav = null;
let editRef = null;
let dirty = false;

const statusEl = document.getElementById('status');

function setDirty(flag) {
  dirty = flag;
  statusEl.textContent = flag ? '⚠ 有未保存的修改' : '✔ 所有更改已保存';
  statusEl.className = 'status ' + (flag ? 'dirty' : 'saved');
}

window.onbeforeunload = () => dirty ? '你有未保存的修改' : null;

/* ===== 加载数据 ===== */
fetch('/api/data')
  .then(r => r.json())
  .then(data => {
    nav = data;
    render();
    initSelectors();
  });

/* ===== 渲染 ===== */
function render() {
  const list = document.getElementById('list');
  list.innerHTML = '';

  nav.categories.forEach(c1 => {
    const group = document.createElement('div');
    group.className = 'group';
    group.innerHTML = `<div class="group-title">${c1.name}</div>`;

    c1.subcategories.forEach(c2 => {
      const cards = document.createElement('div');
      cards.className = 'cards';

      c2.links.forEach(link => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="name">${link.name}</div>
          <div class="url">${link.url}</div>
          <div class="actions">
            <button class="secondary">编辑</button>
            <button class="danger">删除</button>
          </div>
        `;

        card.querySelector('.secondary').onclick = () => startEdit(c1, c2, link);
        card.querySelector('.danger').onclick = () => {
          if (confirm('确认删除？')) {
            c2.links = c2.links.filter(l => l !== link);
            setDirty(true);
            render();
          }
        };

        cards.appendChild(card);
      });

      if (c2.links.length) group.appendChild(cards);
    });

    list.appendChild(group);
  });
}

/* ===== 编辑 ===== */
function initSelectors() {
  const c1 = document.getElementById('cat1');
  const c2 = document.getElementById('cat2');

  c1.innerHTML = nav.categories.map((c,i)=>`<option value="${i}">${c.name}</option>`).join('');
  c1.onchange = () => {
    const idx = c1.value;
    c2.innerHTML = nav.categories[idx].subcategories
      .map((s,i)=>`<option value="${i}">${s.name}</option>`).join('');
  };
  c1.onchange();
}

function startEdit(c1, c2, link) {
  editRef = { c1, c2, link };
  document.getElementById('cat1').value = nav.categories.indexOf(c1);
  document.getElementById('cat1').onchange();
  document.getElementById('cat2').value = c1.subcategories.indexOf(c2);
  document.getElementById('name').value = link.name;
  document.getElementById('url').value = link.url;
  document.getElementById('desc').value = link.desc || '';
}

function applyEdit() {
  const c1 = nav.categories[cat1.value];
  const c2 = c1.subcategories[cat2.value];

  if (editRef) {
    Object.assign(editRef.link, {
      name: name.value,
      url: url.value,
      desc: desc.value
    });
  } else {
    c2.links.push({
      name: name.value,
      url: url.value,
      desc: desc.value
    });
  }

  setDirty(true);
  editRef = null;
  resetEditor();
  render();
}

function resetEditor() {
  name.value = url.value = desc.value = '';
}

/* ===== 保存 ===== */
function saveToKV() {
  fetch('/api/save', {
    method: 'POST',
    body: JSON.stringify(nav)
  }).then(() => setDirty(false));
}
</script>

</body>
</html>

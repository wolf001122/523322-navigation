<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>链接管理</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background:#f5f6f7;
}
header{
  background:#fff;
  padding:12px 20px;
  border-bottom:1px solid #e5e5e5;
  display:flex;
  justify-content:space-between;
}
main{
  padding:20px;
}
.category,.subcategory,.link{
  background:#fff;
  border-radius:8px;
  padding:10px;
  margin-bottom:10px;
}
.category{border-left:5px solid #409eff}
.subcategory{margin-left:20px;border-left:5px solid #67c23a}
.link{
  margin-left:40px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
button{
  padding:4px 8px;
  margin-left:5px;
}
#editor{
  position:fixed;
  right:0;top:0;
  width:320px;
  height:100vh;
  background:#fff;
  border-left:1px solid #ddd;
  padding:15px;
}
#editor input,select{
  width:100%;
  margin-bottom:10px;
}
</style>
</head>

<body>
<header>
  <div>后台链接管理</div>
  <button onclick="save()">保存到 KV</button>
</header>

<main id="tree"></main>

<div id="editor">
  <h3>编辑链接</h3>
  <select id="cat"></select>
  <select id="sub"></select>
  <input id="name" placeholder="网站名称">
  <input id="url" placeholder="URL">
  <input id="desc" placeholder="描述">
  <input id="icon" placeholder="图标 URL">
  <button onclick="apply()">应用修改</button>
</div>

<script>
let nav={},current=null;

fetch('/api/data').then(r=>r.text()).then(parse);

function parse(xml){
  const d=new DOMParser().parseFromString(xml,'text/xml');
  nav.categories=[...d.querySelectorAll('category')].map(c=>({
    name:c.getAttribute('name'),
    subs:[...c.querySelectorAll('subcategory')].map(s=>({
      name:s.getAttribute('name'),
      links:[...s.querySelectorAll('link')].map(l=>({
        name:l.getAttribute('name'),
        url:l.getAttribute('url'),
        desc:l.getAttribute('desc'),
        icon:l.getAttribute('icon')
      }))
    }))
  }));
  render();
}

function render(){
  const t=document.getElementById('tree');
  t.innerHTML='';
  nav.categories.forEach((c,ci)=>{
    const cd=document.createElement('div');
    cd.className='category';
    cd.textContent=c.name;
    t.appendChild(cd);
    c.subs.forEach((s,si)=>{
      const sd=document.createElement('div');
      sd.className='subcategory';
      sd.textContent=s.name;
      t.appendChild(sd);
      s.links.forEach((l,li)=>{
        const ld=document.createElement('div');
        ld.className='link';
        ld.innerHTML=`<span>${l.name}</span>
          <span>
            <button onclick="edit(${ci},${si},${li})">编辑</button>
            <button onclick="del(${ci},${si},${li})">删除</button>
          </span>`;
        t.appendChild(ld);
      });
    });
  });
  fillSelects();
}

function fillSelects(){
  const c=document.getElementById('cat');
  c.innerHTML='';
  nav.categories.forEach((v,i)=>{
    c.innerHTML+=`<option value="${i}">${v.name}</option>`;
  });
  c.onchange=fillSubs;
  fillSubs();
}

function fillSubs(){
  const s=document.getElementById('sub');
  s.innerHTML='';
  nav.categories[cat.value].subs.forEach((v,i)=>{
    s.innerHTML+=`<option value="${i}">${v.name}</option>`;
  });
}

function edit(ci,si,li){
  current={ci,si,li};
  const l=nav.categories[ci].subs[si].links[li];
  cat.value=ci; fillSubs(); sub.value=si;
  name.value=l.name; url.value=l.url;
  desc.value=l.desc||''; icon.value=l.icon||'';
}

function apply(){
  if(!current)return;
  const l=nav.categories[current.ci].subs[current.si].links[current.li];
  l.name=name.value;
  l.url=url.value;
  l.desc=desc.value;
  l.icon=icon.value;
  render();
}

function del(ci,si,li){
  if(confirm('确认删除？')){
    nav.categories[ci].subs[si].links.splice(li,1);
    render();
  }
}

function save(){
  let xml=`<?xml version="1.0" encoding="UTF-8"?><navigation>`;
  nav.categories.forEach(c=>{
    xml+=`<category name="${c.name}">`;
    c.subs.forEach(s=>{
      xml+=`<subcategory name="${s.name}">`;
      s.links.forEach(l=>{
        xml+=`<link name="${l.name}" url="${l.url}" desc="${l.desc||''}" icon="${l.icon||''}"/>`;
      });
      xml+=`</subcategory>`;
    });
    xml+=`</category>`;
  });
  xml+=`</navigation>`;
  fetch('/api/save',{method:'POST',body:xml}).then(()=>alert('已保存'));
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>链接管理</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  margin: 0;
  font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background:#f5f6f7;
}

.topbar {
  position: sticky;
  top: 0;
  z-index: 10;
  background:#fff;
  border-bottom:1px solid #ddd;
  padding:10px 16px;
}

.status.saved { color:#2ecc71; }
.status.dirty { color:#e67e22; }

button {
  padding:6px 12px;
  border-radius:4px;
  border:1px solid #409eff;
  background:#409eff;
  color:#fff;
  cursor:pointer;
}
button.secondary {
  background:#fff;
  color:#409eff;
}
button.danger {
  background:#e74c3c;
  border-color:#e74c3c;
}

.container {
  display:flex;
  gap:16px;
  padding:16px;
}

/* ===== 编辑区 ===== */
.editor {
  width:320px;
  background:#fff;
  border-radius:8px;
  padding:12px;
  box-shadow:0 1px 4px rgba(0,0,0,.08);
  position:sticky;
  top:60px;
  height:fit-content;
}

.editor h3 { margin-top:0; }

.editor label {
  font-size:13px;
  margin-top:8px;
  display:block;
}

.editor input,.editor select {
  width:100%;
  padding:6px;
  margin-top:4px;
}

/* ===== 列表 ===== */
.list { flex:1; }

.group {
  margin-bottom:30px;
}

.group-title {
  font-size:16px;
  margin-bottom:8px;
  color:#333;
  border-left:4px solid #409eff;
  padding-left:8px;
}

.cards {
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
  gap:12px;
}

.card {
  background:#fff;
  border-radius:6px;
  padding:10px;
  box-shadow:0 1px 4px rgba(0,0,0,.08);
  display:flex;
  flex-direction:column;
  gap:6px;
}

.card .name {
  font-weight:600;
  font-size:14px;
}

.card .url {
  font-size:12px;
  color:#666;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.card .actions {
  margin-top:auto;
  display:flex;
  gap:8px;
}
</style>
</head>

<body>

<div class="topbar">
  <div id="status" class="status saved">✔ 已保存</div>
</div>

<div class="container">

  <!-- 编辑区 -->
  <div class="editor">
    <h3 id="editorTitle">新增链接</h3>

    <label>一级分类</label>
    <select id="cat1"></select>

    <label>二级分类</label>
    <select id="cat2"></select>

    <label>名称</label>
    <input id="name">

    <label>URL</label>
    <input id="url">

    <label>描述</label>
    <input id="desc">

    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      <button onclick="applyEdit()">应用修改</button>
      <button class="secondary" onclick="clearEditor()">清空</button>
      <button class="secondary" onclick="saveKV()">保存到 KV</button>
    </div>
  </div>

  <!-- 列表 -->
  <div id="list" class="list"></div>

</div>

<script>
let nav=null;
let editing=null; // {i,j,link}
let dirty=false;

const statusEl=document.getElementById('status');

function setDirty(v){
  dirty=v;
  statusEl.textContent=v?'⚠ 未保存修改':'✔ 已保存';
  statusEl.className='status '+(v?'dirty':'saved');
}
window.onbeforeunload=()=>dirty?'你有未保存修改':null;

/* ===== 加载 ===== */
fetch('/api/data').then(r=>r.text()).then(parseXML);

function parseXML(xmlText){
  const xml=new DOMParser().parseFromString(xmlText,'text/xml');
  nav={categories:[]};

  xml.querySelectorAll('category').forEach(cat=>{
    const c1={name:cat.getAttribute('name'),subcategories:[]};
    cat.querySelectorAll('subcategory').forEach(sub=>{
      const c2={name:sub.getAttribute('name'),links:[]};
      sub.querySelectorAll('link').forEach(l=>{
        c2.links.push({
          name:l.getAttribute('name'),
          url:l.getAttribute('url'),
          desc:l.getAttribute('desc')||''
        });
      });
      c1.subcategories.push(c2);
    });
    nav.categories.push(c1);
  });

  initSelectors();
  render();
}

/* ===== 渲染 ===== */
function render(){
  const list=document.getElementById('list');
  list.innerHTML='';

  nav.categories.forEach((c1,i)=>{
    c1.subcategories.forEach((c2,j)=>{
      if(!c2.links.length)return;

      const g=document.createElement('div');
      g.className='group';
      g.innerHTML=`<div class="group-title">${c1.name} / ${c2.name}</div>`;

      const cards=document.createElement('div');
      cards.className='cards';

      c2.links.forEach(link=>{
        const card=document.createElement('div');
        card.className='card';
        card.innerHTML=`
          <div class="name">${link.name}</div>
          <div class="url">${link.url}</div>
          <div class="actions">
            <button class="secondary">编辑</button>
            <button class="danger">删除</button>
          </div>`;
        card.querySelector('.secondary').onclick=()=>startEdit(i,j,link);
        card.querySelector('.danger').onclick=()=>{
          if(confirm('确认删除？')){
            c2.links=c2.links.filter(l=>l!==link);
            setDirty(true);
            render();
          }
        };
        cards.appendChild(card);
      });

      g.appendChild(cards);
      list.appendChild(g);
    });
  });
}

/* ===== 编辑 ===== */
function initSelectors(){
  cat1.innerHTML=nav.categories.map((c,i)=>`<option value="${i}">${c.name}</option>`).join('');
  cat1.onchange=()=>{
    const c=nav.categories[cat1.value];
    cat2.innerHTML=c.subcategories.map((s,i)=>`<option value="${i}">${s.name}</option>`).join('');
  };
  cat1.onchange();
}

function startEdit(i,j,link){
  editing={i,j,link};
  editorTitle.textContent='编辑链接';
  cat1.value=i; cat1.onchange();
  cat2.value=j;
  name.value=link.name;
  url.value=link.url;
  desc.value=link.desc;
}

function clearEditor(){
  editing=null;
  editorTitle.textContent='新增链接';
  name.value=url.value=desc.value='';
}

/* ===== 应用 ===== */
function applyEdit(){
  const i=+cat1.value;
  const j=+cat2.value;

  if(editing){
    Object.assign(editing.link,{
      name:name.value,
      url:url.value,
      desc:desc.value
    });
  }else{
    nav.categories[i].subcategories[j].links.push({
      name:name.value,
      url:url.value,
      desc:desc.value
    });
  }
  setDirty(true);
  clearEditor();
  render();
}

/* ===== 保存 ===== */
function saveKV(){
  let xml=`<?xml version="1.0" encoding="UTF-8"?>\n<navigation>\n`;
  nav.categories.forEach(c1=>{
    xml+=`  <category name="${c1.name}">\n`;
    c1.subcategories.forEach(c2=>{
      xml+=`    <subcategory name="${c2.name}">\n`;
      c2.links.forEach(l=>{
        xml+=`      <link name="${l.name}" url="${l.url}" desc="${l.desc}"/>\n`;
      });
      xml+=`    </subcategory>\n`;
    });
    xml+=`  </category>\n`;
  });
  xml+=`</navigation>`;
  fetch('/api/save',{method:'POST',body:xml}).then(()=>setDirty(false));
}
</script>

</body>
</html>

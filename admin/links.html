<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>链接管理</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:system-ui;background:#f4f6f8}
header{background:#1f2937;color:#fff;padding:14px 20px}
.container{display:flex;height:calc(100vh - 52px)}
.editor{width:320px;background:#fff;border-right:1px solid #e5e7eb;padding:16px}
.editor label{display:block;margin-top:10px;font-size:13px}
.editor input,.editor select{width:100%;padding:6px;margin-top:4px}
.editor button{width:100%;margin-top:10px;padding:8px;border:none;border-radius:4px;cursor:pointer}
.apply{background:#409eff;color:#fff}
.clear{background:#9ca3af;color:#fff}
.save{background:#22c55e;color:#fff;font-weight:600}

.cards{flex:1;padding:16px;overflow-y:auto}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
.card{background:#fff;border-radius:6px;padding:12px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
.card strong{display:block}
.card small{color:#666}
.actions{margin-top:8px;display:flex;gap:8px}
.actions button{flex:1;font-size:12px}
</style>
</head>

<body>
<header>链接管理（修改后需保存到 KV）</header>

<div class="container">

<div class="editor">
  <label>一级分类</label>
  <select id="cat"></select>

  <label>二级分类</label>
  <select id="sub"></select>

  <label>名称</label>
  <input id="name">

  <label>网址</label>
  <input id="url">

  <label>描述</label>
  <input id="desc">

  <label>图标</label>
  <input id="icon">

  <button class="apply" onclick="applyEdit()">应用修改</button>
  <button class="clear" onclick="clearForm()">清空</button>
  <button class="save" onclick="saveKV()">保存到 KV</button>
</div>

<div class="cards">
  <div class="grid" id="list"></div>
</div>

</div>

<script>
let xmlDoc;
let editing = null;

fetch('/api/data')
  .then(r=>r.text())
  .then(t=>{
    xmlDoc=new DOMParser().parseFromString(t,'text/xml');
    buildCat();
    render();
  });

function buildCat(){
  cat.innerHTML='';
  xmlDoc.querySelectorAll('category').forEach(c=>{
    const o=document.createElement('option');
    o.value=o.textContent=c.getAttribute('name');
    cat.appendChild(o);
  });
  buildSub();
  cat.onchange=buildSub;
}

function buildSub(){
  sub.innerHTML='';
  xmlDoc.querySelectorAll(
    `category[name="${cat.value}"] subcategory`
  ).forEach(s=>{
    const o=document.createElement('option');
    o.value=o.textContent=s.getAttribute('name');
    sub.appendChild(o);
  });
}

function render(){
  list.innerHTML='';
  xmlDoc.querySelectorAll('category').forEach(c=>{
    c.querySelectorAll('subcategory').forEach(s=>{
      s.querySelectorAll('link').forEach(l=>{
        const d=document.createElement('div');
        d.className='card';
        d.dataset.cat=c.getAttribute('name');
        d.dataset.sub=s.getAttribute('name');
        d.dataset.name=l.getAttribute('name');

        d.innerHTML=`
<strong>${l.getAttribute('name')}</strong>
<small>${c.getAttribute('name')} / ${s.getAttribute('name')}</small>
<small>${l.getAttribute('url')}</small>
<div class="actions">
<button onclick="edit(this)">编辑</button>
<button onclick="del(this)">删除</button>
</div>`;
        list.appendChild(d);
      });
    });
  });
}

function findLink(catN,subN,name){
  return xmlDoc.querySelector(
    `category[name="${catN}"] subcategory[name="${subN}"] link[name="${name}"]`
  );
}

function edit(btn){
  const card=btn.closest('.card');
  const l=findLink(card.dataset.cat,card.dataset.sub,card.dataset.name);
  if(!l)return alert('未找到数据');

  editing=l;

  cat.value=card.dataset.cat;
  buildSub();
  sub.value=card.dataset.sub;

  name.value=l.getAttribute('name')||'';
  url.value=l.getAttribute('url')||'';
  desc.value=l.getAttribute('desc')||'';
  icon.value=l.getAttribute('icon')||'';
}

function applyEdit(){
  if(!name.value||!url.value){
    alert('名称和网址不能为空');
    return;
  }

  if(!editing){
    const s=xmlDoc.querySelector(
      `category[name="${cat.value}"] subcategory[name="${sub.value}"]`
    );
    editing=xmlDoc.createElement('link');
    s.appendChild(editing);
  }

  editing.setAttribute('name',name.value);
  editing.setAttribute('url',url.value);
  editing.setAttribute('desc',desc.value);
  editing.setAttribute('icon',icon.value);

  clearForm();
  render();
}

function del(btn){
  const card=btn.closest('.card');
  const l=findLink(card.dataset.cat,card.dataset.sub,card.dataset.name);
  if(l&&confirm('确定删除？')){
    l.remove();
    render();
  }
}

function clearForm(){
  name.value=url.value=desc.value=icon.value='';
  editing=null;
}

function saveKV(){
  const xml=new XMLSerializer().serializeToString(xmlDoc);
  fetch('/api/save',{method:'POST',body:xml})
    .then(()=>alert('已保存到 KV'));
}
</script>

</body>
</html>

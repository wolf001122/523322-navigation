<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>网站提交</title>
<style>
  body { padding: 24px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f8f9fa; color: #202124; }
  h2 { font-size: 28px; font-weight: 500; margin-bottom: 24px; text-align: center; }
  form { max-width: 600px; margin: 0 auto; background: #fff; padding: 32px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); }
  select, input, textarea { width: 100%; padding: 12px; margin: 12px 0; border: 1px solid #dadce0; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
  select:focus, input:focus, textarea:focus { outline: none; border-color: #1a73e8; box-shadow: 0 0 0 3px rgba(26,115,232,0.2); }
  #captchaQuestion { font-weight: bold; margin: 16px 0; color: #1a73e8; text-align: center; font-size: 18px; }
  button { width: 100%; padding: 14px; background: #1a73e8; color: #fff; border: none; border-radius: 8px; font-size: 18px; cursor: pointer; margin-top: 20px; }
  button:hover { background: #1557b0; }
  #msg { text-align: center; margin-top: 20px; font-size: 16px; min-height: 24px; }
  .error { color: #d93025; }
  .success { color: #137333; }
</style>
</head>
<body>
  <h2>网站提交</h2>
  <form onsubmit="submitSite(event)">
    <select id="c1" required></select>
    <select id="c2" required></select>
    <input id="name" placeholder="网站名称" required>
    <input id="url" placeholder="https://example.com" required>
    <textarea id="desc" placeholder="网站简介（简短描述网站功能和特色）" rows="4" required></textarea>
    <input id="hp" style="display:none" autocomplete="off" readonly>
    <div id="captchaQuestion"></div>
    <input id="captchaAnswer" placeholder="请输入答案" required>
    <button type="submit">提交网站</button>
  </form>
  <p id="msg"></p>

<script>
const API = '/api/data';

// 全局变量
let data = [];
let c1 = document.getElementById('c1');
let c2 = document.getElementById('c2');
let nameInput = document.getElementById('name');
let urlInput = document.getElementById('url');
let descInput = document.getElementById('desc');
let hp = document.getElementById('hp');
let msg = document.getElementById('msg');
let captchaQuestion = document.getElementById('captchaQuestion');
let captchaAnswer = document.getElementById('captchaAnswer');

// 立即生成验证码（独立于分类加载）
generateCaptcha();

// 加载分类数据
fetch(API)
  .then(r => r.text())
  .then(t => {
    const xml = new DOMParser().parseFromString(t, 'text/xml');
    data = [...xml.querySelectorAll('category')].map(c => ({
      name: c.getAttribute('name'),
      subs: [...c.querySelectorAll('subcategory')].map(s => ({
        name: s.getAttribute('name')
      }))
    }));
    initCats();
  })
  .catch(() => {
    msg.textContent = '加载分类失败，请刷新页面重试';
    msg.className = 'error';
  });

// 初始化分类下拉框
function initCats() {
  c1.innerHTML = '<option value="">请选择一级分类</option>';
  data.forEach((cat, i) => {
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = cat.name;
    c1.appendChild(opt);
  });

  c1.onchange = () => {
    c2.innerHTML = '<option value="">请选择二级分类</option>';
    if (c1.value !== '') {
      data[c1.value].subs.forEach(sub => {
        const opt = document.createElement('option');
        opt.textContent = sub.name;
        c2.appendChild(opt);
      });
    }
  };
}

// 生成算术验证码
function generateCaptcha() {
  const a = Math.floor(Math.random() * 10) + 1;
  const b = Math.floor(Math.random() * 10) + 1;
  const operators = ['+', '-', '×'];
  const op = operators[Math.floor(Math.random() * operators.length)];
  let question, answer;

  switch (op) {
    case '+': question = `${a} + ${b} = ?`; answer = a + b; break;
    case '-': question = `${a} - ${b} = ?`; answer = a - b; break;
    case '×': question = `${a} × ${b} = ?`; answer = a * b; break;
  }

  captchaQuestion.textContent = `验证码：${question}`;
  window.correctAnswer = answer;
}

// 提交处理
async function submitSite(e) {
  e.preventDefault();

  if (hp && hp.value !== '') {
    msg.textContent = '异常操作，已阻止';
    msg.className = 'error';
    return;
  }

  const userAnswer = parseInt(captchaAnswer.value.trim(), 10);
  if (isNaN(userAnswer) || userAnswer !== window.correctAnswer) {
    msg.textContent = '验证码错误，请重新计算';
    msg.className = 'error';
    generateCaptcha();
    captchaAnswer.value = '';
    return;
  }

  const submittedUrl = urlInput.value.trim();
  if (!submittedUrl) {
    msg.textContent = '请填写网站URL';
    msg.className = 'error';
    return;
  }

  let submittedRoot = '';
  try {
    let hostname = new URL(submittedUrl).hostname.toLowerCase();
    if (hostname.startsWith('www.')) hostname = hostname.slice(4);
    const parts = hostname.split('.');
    if (parts.length <= 2) {
      submittedRoot = hostname;
    } else {
      const last = parts[parts.length - 1];
      const secondLast = parts[parts.length - 2];
      const countrySuffixes = ['cn', 'uk', 'jp', 'de', 'fr', 'au', 'br', 'ru', 'in', 'ca', 'it', 'es', 'nl', 'kr', 'tw', 'hk', 'sg'];
      const publicSuffixes = ['com', 'net', 'org', 'gov', 'edu', 'co', 'ne', 'or', 'go', 'ac', 'mil', 'info', 'biz'];
      if (countrySuffixes.includes(last) && publicSuffixes.includes(secondLast) && parts.length >= 3) {
        submittedRoot = parts.slice(-3).join('.');
      } else {
        submittedRoot = parts.slice(-2).join('.');
      }
    }
  } catch {
    msg.textContent = 'URL格式不正确';
    msg.className = 'error';
    return;
  }

  try {
    const res = await fetch(API);
    const text = await res.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(text, 'text/xml');
    const existingRootDomains = new Set();
    doc.querySelectorAll('link').forEach(link => {
      let url = link.getAttribute('url');
      if (url) {
        try {
          let hostname = new URL(url).hostname.toLowerCase();
          if (hostname.startsWith('www.')) hostname = hostname.slice(4);
          const parts = hostname.split('.');
          let root = '';
          if (parts.length <= 2) {
            root = hostname;
          } else {
            const last = parts[parts.length - 1];
            const secondLast = parts[parts.length - 2];
            if (countrySuffixes.includes(last) && publicSuffixes.includes(secondLast) && parts.length >= 3) {
              root = parts.slice(-3).join('.');
            } else {
              root = parts.slice(-2).join('.');
            }
          }
          if (root) existingRootDomains.add(root);
        } catch {}
      }
    });

    if (existingRootDomains.has(submittedRoot)) {
      alert('此一级域名已存在（包括二级域名如 pan.baidu.com 等），请勿重复提交！');
      msg.textContent = '重复域名，提交已阻止';
      msg.className = 'error';
      generateCaptcha();
      return;
    }

    const site = {
      cat1: c1.options[c1.selectedIndex]?.text || '',
      cat2: c2.options[c2.selectedIndex]?.text || '',
      name: nameInput.value.trim(),
      url: submittedUrl,
      desc: descInput.value.trim()
    };

    if (!site.cat1 || !site.cat2 || !site.name || !site.url || !site.desc) {
      msg.textContent = '请填写完整信息并选择分类';
      msg.className = 'error';
      generateCaptcha();
      return;
    }

    msg.textContent = '提交中...';
    msg.className = '';

    const postRes = await fetch('/api/submit', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(site)
    });
    const text = await postRes.text();
    if (text.includes('成功')) {
      msg.textContent = '提交成功，等待管理员审核';
      msg.className = 'success';
      e.target.reset();
      generateCaptcha();
      c1.selectedIndex = 0;
      c2.innerHTML = '<option value="">请选择二级分类</option>';
    } else {
      msg.textContent = '提交失败：' + text;
      msg.className = 'error';
      generateCaptcha();
    }
  } catch {
    msg.textContent = '网络错误，请重试';
    msg.className = 'error';
    generateCaptcha();
  }
}
</script>
</body>
</html>

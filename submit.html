<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>网站提交</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    background: #f8f9fa;
    color: #202124;
    padding: 40px 20px;
    min-height: calc(100vh - 80px);
  }
  h1 {
    font-size: 28px;
    font-weight: 500;
    text-align: center;
    margin-bottom: 32px;
    color: #202124;
  }
  .container {
    max-width: 600px;
    margin: 0 auto;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 2px 6px 2px rgba(60,64,67,0.15);
    padding: 32px;
  }
  form {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  label {
    font-size: 14px;
    color: #5f6368;
    margin-bottom: 4px;
  }
  select,
  input {
    padding: 12px 16px;
    font-size: 16px;
    border: 1px solid #dadce0;
    border-radius: 8px;
    outline: none;
    background: #fff;
    transition: box-shadow 0.2s, border-color 0.2s;
  }
  select:focus,
  input:focus {
    border-color: #1a73e8;
    box-shadow: 0 1px 6px rgba(32,33,36,0.28);
  }
  #captcha {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 8px;
  }
  #captcha label {
    margin: 0;
    font-size: 16px;
    color: #202124;
    white-space: nowrap;
  }
  #captcha input {
    width: 120px;
    flex-shrink: 0;
  }
  button {
    margin-top: 24px;
    padding: 12px 24px;
    background: #1a73e8;
    color: #fff;
    font-size: 16px;
    font-weight: 500;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: box-shadow 0.2s, transform 0.1s;
  }
  button:hover {
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  }
  button:active {
    transform: translateY(1px);
  }
  .note {
    font-size: 13px;
    color: #5f6368;
    text-align: center;
    margin-top: 24px;
  }
</style>
</head>
<body>
  <h1>提交您的网站</h1>
  <div class="container">
    <form id="submitForm">
      <div>
        <label for="cat1">一级分类</label>
        <select id="cat1" required></select>
      </div>

      <div>
        <label for="cat2">二级分类</label>
        <select id="cat2" required></select>
      </div>

      <div>
        <label for="name">网站名称 <span style="color:#d93025;">*</span></label>
        <input id="name" type="text" required maxlength="50" placeholder="请输入网站名称">
      </div>

      <div>
        <label for="url">网站网址 <span style="color:#d93025;">*</span></label>
        <input id="url" type="url" required placeholder="https://www.example.com">
      </div>

      <div>
        <label for="desc">网站描述（可选）</label>
        <input id="desc" type="text" maxlength="100" placeholder="简短描述您的网站">
      </div>

      <div>
        <label>验证码 <span style="color:#d93025;">*</span></label>
        <div id="captcha">
          <label id="captchaQuestion"></label>
          <input id="captchaAnswer" type="text" required placeholder="答案">
        </div>
      </div>

      <button type="submit">提交网站</button>
    </form>

    <p class="note">提交后将由管理员审核，感谢您的贡献！</p>
  </div>

<script>
let xmlDoc;
let captchaNum1, captchaNum2, captchaAnswer;

function generateCaptcha() {
  captchaNum1 = Math.floor(Math.random() * 10) + 1;
  captchaNum2 = Math.floor(Math.random() * 10) + 1;
  captchaAnswer = captchaNum1 + captchaNum2;
  document.getElementById('captchaQuestion').textContent = `${captchaNum1} + ${captchaNum2} = ?`;
}

function getDomain(url) {
  try {
    const hostname = new URL(url).hostname;
    return hostname.startsWith('www.') ? hostname.slice(4) : hostname;
  } catch (e) {
    return '';
  }
}

fetch('/api/data')
  .then(r => r.text())
  .then(t => {
    xmlDoc = new DOMParser().parseFromString(t, 'text/xml');
    buildCat1();
    generateCaptcha();
  })
  .catch(e => alert('加载分类失败，请稍后再试'));

function buildCat1() {
  const cat1 = document.getElementById('cat1');
  cat1.innerHTML = '<option value="">请选择一级分类</option>';
  xmlDoc.querySelectorAll('category').forEach(c => {
    const o = document.createElement('option');
    o.value = o.textContent = c.getAttribute('name');
    cat1.appendChild(o);
  });
  cat1.onchange = buildCat2;
}

function buildCat2() {
  const cat2 = document.getElementById('cat2');
  cat2.innerHTML = '<option value="">请选择二级分类</option>';
  const catName = document.getElementById('cat1').value;
  if (!catName) return;
  xmlDoc.querySelectorAll(`category[name="${catName}"] subcategory`).forEach(s => {
    const o = document.createElement('option');
    o.value = o.textContent = s.getAttribute('name');
    cat2.appendChild(o);
  });
}

function isDomainExists(submitUrl) {
  const submitDomain = getDomain(submitUrl);
  if (!submitDomain) return false;
  const allLinks = xmlDoc.querySelectorAll('link');
  for (let link of allLinks) {
    const existingUrl = link.getAttribute('url');
    const existingDomain = getDomain(existingUrl);
    if (existingDomain === submitDomain) {
      return true;
    }
  }
  return false;
}

document.getElementById('submitForm').onsubmit = async function(e) {
  e.preventDefault();

  const userAnswer = parseInt(document.getElementById('captchaAnswer').value, 10);
  if (userAnswer !== captchaAnswer) {
    alert('验证码错误，请重新输入！');
    generateCaptcha();
    return;
  }

  const urlInput = document.getElementById('url').value.trim();
  const data = {
    cat1: document.getElementById('cat1').value,
    cat2: document.getElementById('cat2').value,
    name: document.getElementById('name').value.trim(),
    url: urlInput,
    desc: document.getElementById('desc').value.trim()
  };

  if (!data.cat1 || !data.cat2 || !data.name || !data.url) {
    alert('请填写所有必填项！');
    return;
  }

  if (isDomainExists(urlInput)) {
    alert('该网站已收录，请勿重复提交！');
    return;
  }

  try {
    const res = await fetch('/api/submit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    if (res.ok) {
      alert('提交成功！等待管理员审核');
      this.reset();
      buildCat1();
      generateCaptcha();
    } else {
      alert(await res.text());
    }
  } catch (e) {
    alert('提交失败，请稍后再试');
  }
};
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>网站提交</title>
<style>
  body { padding: 24px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f8f9fa; color: #202124; }
  h2 { font-size: 28px; font-weight: 500; margin-bottom: 24px; text-align: center; }
  form { max-width: 600px; margin: 0 auto; background: #fff; padding: 32px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); }
  select, input, textarea { width: 100%; padding: 12px; margin: 12px 0; border: 1px solid #dadce0; border-radius: 8px; font-size: 16px; }
  #captchaQuestion { font-weight: bold; margin: 16px 0; color: #1a73e8; text-align: center; font-size: 18px; }
  button { width: 100%; padding: 14px; background: #1a73e8; color: #fff; border: none; border-radius: 8px; font-size: 18px; cursor: pointer; }
  #msg { text-align: center; margin-top: 20px; min-height: 24px; }
</style>
</head>

<body>
<h2>网站提交</h2>

<form id="submitForm">
  <select id="c1" required></select>
  <select id="c2" required></select>
  <input id="name" placeholder="网站名称" required>
  <input id="url" placeholder="https://example.com" required>
  <textarea id="desc" placeholder="网站简介" rows="4" required></textarea>
  <input id="hp" style="display:none" autocomplete="off">
  <div id="captchaQuestion"></div>
  <input id="captchaAnswer" placeholder="请输入答案" required>
  <button type="submit">提交网站</button>
</form>

<p id="msg"></p>

<script>
const API = '/api/data';

let data = [];
let c1, c2, nameInput, urlInput, descInput, hp, msg, captchaQuestion, captchaAnswer;

document.addEventListener('DOMContentLoaded', () => {
  // DOM 先绑定
  c1 = document.getElementById('c1');
  c2 = document.getElementById('c2');
  nameInput = document.getElementById('name');
  urlInput = document.getElementById('url');
  descInput = document.getElementById('desc');
  hp = document.getElementById('hp');
  msg = document.getElementById('msg');
  captchaQuestion = document.getElementById('captchaQuestion');
  captchaAnswer = document.getElementById('captchaAnswer');

  loadCategories();
  document.getElementById('submitForm').onsubmit = submitSite;
});

function loadCategories() {
  fetch(API)
    .then(r => r.text())
    .then(t => {
      const xml = new DOMParser().parseFromString(t, 'text/xml');
      data = [...xml.querySelectorAll('category')].map(c => ({
        name: c.getAttribute('name'),
        subs: [...c.querySelectorAll('subcategory')].map(s => ({
          name: s.getAttribute('name')
        }))
      }));
      initCats();
      generateCaptcha();
    })
    .catch(() => {
      msg.textContent = '分类加载失败，请刷新页面';
    });
}

function initCats() {
  c1.innerHTML = '<option value="">请选择一级分类</option>';
  c2.innerHTML = '<option value="">请选择二级分类</option>';

  data.forEach((cat, i) => {
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = cat.name;
    c1.appendChild(opt);
  });

  c1.onchange = () => {
    c2.innerHTML = '<option value="">请选择二级分类</option>';
    if (c1.value !== '') {
      data[c1.value].subs.forEach(sub => {
        const opt = document.createElement('option');
        opt.textContent = sub.name;
        c2.appendChild(opt);
      });
    }
  };
}

function generateCaptcha() {
  const a = Math.floor(Math.random() * 10) + 1;
  const b = Math.floor(Math.random() * 10) + 1;
  const ops = ['+', '-', '×'];
  const op = ops[Math.floor(Math.random() * ops.length)];

  let q, ans;
  if (op === '+') { q = `${a} + ${b} = ?`; ans = a + b; }
  if (op === '-') { q = `${a} - ${b} = ?`; ans = a - b; }
  if (op === '×') { q = `${a} × ${b} = ?`; ans = a * b; }

  captchaQuestion.textContent = '验证码：' + q;
  window.correctAnswer = ans;
}

function submitSite(e) {
  e.preventDefault();

  if (hp.value) return;

  if (parseInt(captchaAnswer.value) !== window.correctAnswer) {
    msg.textContent = '验证码错误';
    generateCaptcha();
    return;
  }

  msg.textContent = '提交中...';

  fetch('/api/submit', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({
      cat1: c1.options[c1.selectedIndex].text,
      cat2: c2.options[c2.selectedIndex].text,
      name: nameInput.value.trim(),
      url: urlInput.value.trim(),
      desc: descInput.value.trim()
    })
  })
  .then(r => r.text())
  .then(t => {
    msg.textContent = t.includes('成功') ? '提交成功，等待审核' : t;
    generateCaptcha();
  })
  .catch(() => msg.textContent = '网络错误');
}
</script>
</body>
</html>

<!-- submit.html : 被 index.html 通过 fetch + innerHTML 加载 -->
<div id="submit-page">
  <h2>网站提交</h2>

  <form id="submitForm">
    <select id="c1" required></select>
    <select id="c2" required></select>

    <input id="name" placeholder="网站名称" required>
    <input id="url" placeholder="https://example.com" required>
    <textarea id="desc" rows="4" placeholder="网站简介（简短描述网站功能和特色）" required></textarea>

    <!-- 蜜罐 -->
    <input id="hp" style="display:none" autocomplete="off" readonly>

    <!-- 验证码 -->
    <div id="captchaQuestion"></div>
    <input id="captchaAnswer" placeholder="请输入答案" required>

    <button type="submit">提交网站</button>
  </form>

  <p id="msg"></p>
</div>

<style>
#submit-page{
  padding:24px;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
  background:#f8f9fa;
  color:#202124;
}
#submit-page h2{
  font-size:28px;
  font-weight:500;
  margin-bottom:24px;
  text-align:center;
}
#submit-page form{
  max-width:600px;
  margin:0 auto;
  background:#fff;
  padding:32px;
  border-radius:12px;
  box-shadow:0 1px 3px rgba(0,0,0,0.12);
}
#submit-page select,
#submit-page input,
#submit-page textarea{
  width:100%;
  padding:12px;
  margin:12px 0;
  border:1px solid #dadce0;
  border-radius:8px;
  font-size:16px;
}
#submit-page select:focus,
#submit-page input:focus,
#submit-page textarea:focus{
  outline:none;
  border-color:#1a73e8;
  box-shadow:0 0 0 3px rgba(26,115,232,.2);
}
#captchaQuestion{
  font-weight:bold;
  margin:16px 0;
  color:#1a73e8;
  text-align:center;
  font-size:18px;
}
#submit-page button{
  width:100%;
  padding:14px;
  background:#1a73e8;
  color:#fff;
  border:none;
  border-radius:8px;
  font-size:18px;
  cursor:pointer;
}
#submit-page button:hover{background:#1557b0;}
#msg{
  text-align:center;
  margin-top:20px;
  font-size:16px;
  min-height:24px;
}
.error{color:#d93025;}
.success{color:#137333;}
</style>

<script>
/* =========================================================
   供 index.html 调用的初始化函数
   ========================================================= */
window.initSubmitPage = function () {

  const API = '/api/data';

  const c1 = document.getElementById('c1');
  const c2 = document.getElementById('c2');
  const nameInput = document.getElementById('name');
  const urlInput = document.getElementById('url');
  const descInput = document.getElementById('desc');
  const hp = document.getElementById('hp');
  const msg = document.getElementById('msg');
  const captchaQuestion = document.getElementById('captchaQuestion');
  const captchaAnswer = document.getElementById('captchaAnswer');
  const form = document.getElementById('submitForm');

  let data = [];

  /* ---------- 加载分类 ---------- */
  fetch(API)
    .then(r => r.text())
    .then(t => {
      const xml = new DOMParser().parseFromString(t, 'text/xml');
      data = [...xml.querySelectorAll('category')].map(c => ({
        name: c.getAttribute('name'),
        subs: [...c.querySelectorAll('subcategory')].map(s => ({
          name: s.getAttribute('name')
        }))
      }));
      initCats();
      generateCaptcha();
    })
    .catch(() => {
      msg.textContent = '分类加载失败';
      msg.className = 'error';
    });

  function initCats(){
    c1.innerHTML = '<option value="">请选择一级分类</option>';
    c2.innerHTML = '<option value="">请选择二级分类</option>';

    data.forEach((cat,i)=>{
      const o=document.createElement('option');
      o.value=i;
      o.textContent=cat.name;
      c1.appendChild(o);
    });

    c1.onchange=()=>{
      c2.innerHTML='<option value="">请选择二级分类</option>';
      if(c1.value!==''){
        data[c1.value].subs.forEach(s=>{
          const o=document.createElement('option');
          o.textContent=s.name;
          c2.appendChild(o);
        });
      }
    };
  }

  /* ---------- 验证码 ---------- */
  function generateCaptcha(){
    const a=Math.floor(Math.random()*10)+1;
    const b=Math.floor(Math.random()*10)+1;
    const ops=['+','-','×'];
    const op=ops[Math.floor(Math.random()*ops.length)];
    let ans;
    if(op==='+') ans=a+b;
    if(op==='-') ans=a-b;
    if(op==='×') ans=a*b;
    captchaQuestion.textContent=`验证码：${a} ${op} ${b} = ?`;
    window._submitCaptcha=ans;
  }

  /* ---------- 提交 ---------- */
  form.onsubmit = e => {
    e.preventDefault();

    if(hp.value!==''){
      msg.textContent='异常操作';
      msg.className='error';
      return;
    }

    if(parseInt(captchaAnswer.value,10)!==window._submitCaptcha){
      msg.textContent='验证码错误';
      msg.className='error';
      generateCaptcha();
      captchaAnswer.value='';
      return;
    }

    const site={
      cat1:c1.options[c1.selectedIndex]?.text,
      cat2:c2.options[c2.selectedIndex]?.text,
      name:nameInput.value.trim(),
      url:urlInput.value.trim(),
      desc:descInput.value.trim()
    };

    if(!site.cat1||!site.cat2||!site.name||!site.url||!site.desc){
      msg.textContent='请填写完整信息';
      msg.className='error';
      generateCaptcha();
      return;
    }

    msg.textContent='提交中...';

    fetch('/api/submit',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(site)
    })
    .then(r=>r.text())
    .then(t=>{
      if(t.includes('成功')){
        msg.textContent='提交成功，等待审核';
        msg.className='success';
        form.reset();
        generateCaptcha();
      }else{
        msg.textContent='提交失败：'+t;
        msg.className='error';
        generateCaptcha();
      }
    })
    .catch(()=>{
      msg.textContent='网络错误';
      msg.className='error';
      generateCaptcha();
    });
  };
};
</script>

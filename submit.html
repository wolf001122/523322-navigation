<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>网站提交</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system;
  background: #f8f9fa;
  color: #202124;
  padding: 24px;
}
h1 {
  font-size: 24px;
  margin-bottom: 24px;
  text-align: center;
}
form {
  max-width: 480px;
  margin: 0 auto;
  background: #fff;
  padding: 24px;
  border-radius: 8px;
  box-shadow: 0 1px 6px rgba(32,33,36,0.28);
}
label {
  display: block;
  font-size: 14px;
  margin: 12px 0 4px;
  color: #5f6368;
}
input, select {
  width: 100%;
  padding: 12px;
  font-size: 16px;
  border: 1px solid #dadce0;
  border-radius: 4px;
  outline: none;
  transition: border 0.2s;
}
input:focus, select:focus {
  border-color: #1a73e8;
}
button {
  width: 100%;
  padding: 12px;
  margin-top: 24px;
  background: #1a73e8;
  color: #fff;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 16px;
  transition: background 0.2s;
}
button:hover {
  background: #1669c1;
}
#message {
  margin-top: 12px;
  text-align: center;
  color: #1a73e8;
}
.error {
  color: red;
}
#captcha {
  display: flex;
  align-items: center;
  margin-top: 12px;
}
#captcha label {
  margin: 0 8px 0 0;
  white-space: nowrap;
}
#captcha input {
  width: 80px;
}
</style>
</head>
<body>
<h1>提交您的网站</h1>
<form id="submitForm">
  <label for="cat1">一级分类</label>
  <select id="cat1" required></select>
  
  <label for="cat2">二级分类</label>
  <select id="cat2" required></select>
  
  <label for="name">网站名称</label>
  <input id="name" type="text" required maxlength="50">
  
  <label for="url">网站网址</label>
  <input id="url" type="url" required placeholder="https://example.com">
  
  <label for="desc">网站描述（可选）</label>
  <input id="desc" type="text" maxlength="100">
  
  <div id="captcha">
    <label id="captchaQuestion"></label>
    <input id="captchaAnswer" type="text" required placeholder="请输入答案">
  </div>
  
  <button type="submit">提交</button>
</form>
<div id="message"></div>

<script>
let xmlDoc;
let captchaNum1, captchaNum2, captchaAnswer;

// 生成随机验证码问题
function generateCaptcha() {
  captchaNum1 = Math.floor(Math.random() * 10) + 1;
  captchaNum2 = Math.floor(Math.random() * 10) + 1;
  captchaAnswer = captchaNum1 + captchaNum2;
  document.getElementById('captchaQuestion').textContent = `${captchaNum1} + ${captchaNum2} = ?`;
}

// 提取域名（和首页完全一致）
function getDomain(url) {
  try {
    const hostname = new URL(url).hostname;
    return hostname.startsWith('www.') ? hostname.slice(4) : hostname;
  } catch (e) {
    return '';
  }
}

// 加载分类数据
fetch('/api/data')
  .then(r => r.text())
  .then(t => {
    xmlDoc = new DOMParser().parseFromString(t, 'text/xml');
    buildCat1();
    generateCaptcha();
  })
  .catch(e => alert('加载分类失败，请稍后再试'));

// 构建一级分类
function buildCat1() {
  const cat1 = document.getElementById('cat1');
  cat1.innerHTML = '<option value="">请选择</option>';
  xmlDoc.querySelectorAll('category').forEach(c => {
    const o = document.createElement('option');
    o.value = o.textContent = c.getAttribute('name');
    cat1.appendChild(o);
  });
  cat1.onchange = buildCat2;
}

// 构建二级分类
function buildCat2() {
  const cat2 = document.getElementById('cat2');
  cat2.innerHTML = '<option value="">请选择</option>';
  const catName = document.getElementById('cat1').value;
  if (!catName) return;
  xmlDoc.querySelectorAll(`category[name="${catName}"] subcategory`).forEach(s => {
    const o = document.createElement('option');
    o.value = o.textContent = s.getAttribute('name');
    cat2.appendChild(o);
  });
}

// 查重函数：遍历所有 link 的 url，判断域名是否已存在
function isDomainExists(submitUrl) {
  const submitDomain = getDomain(submitUrl);
  if (!submitDomain) return false;
  
  const allLinks = xmlDoc.querySelectorAll('link');
  for (let link of allLinks) {
    const existingUrl = link.getAttribute('url');
    const existingDomain = getDomain(existingUrl);
    if (existingDomain === submitDomain) {
      return true;
    }
  }
  return false;
}

// 表单提交
document.getElementById('submitForm').onsubmit = async function(e) {
  e.preventDefault();

  const userAnswer = parseInt(document.getElementById('captchaAnswer').value, 10);
  if (userAnswer !== captchaAnswer) {
    alert('验证码错误，请重新输入！');
    generateCaptcha();
    return;
  }

  const urlInput = document.getElementById('url').value.trim();
  const data = {
    cat1: document.getElementById('cat1').value,
    cat2: document.getElementById('cat2').value,
    name: document.getElementById('name').value.trim(),
    url: urlInput,
    desc: document.getElementById('desc').value.trim()
  };

  if (!data.cat1 || !data.cat2 || !data.name || !data.url) {
    alert('请填写所有必填项！');
    return;
  }

  // ★★★ 查重核心：提交前检查域名是否已存在 ★★★
  if (isDomainExists(urlInput)) {
    alert('该网站已收录，请勿重复提交！');
    return;
  }

  try {
    const res = await fetch('/api/submit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    if (res.ok) {
      alert('提交成功！等待管理员审核');
      this.reset();
      buildCat1();           // 重置分类
      generateCaptcha();     // 刷新验证码
    } else {
      alert(await res.text());
    }
  } catch (e) {
    alert('提交失败，请稍后再试');
  }
};
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>网站提交</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* ===== 全局风格（与首页一致） ===== */
body {
  margin: 0;
  padding: 32px 16px;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI";
  background: linear-gradient(180deg, #f1f3f4, #f8f9fa);
  color: #202124;
}

/* 标题 */
h1 {
  text-align: center;
  font-size: 22px;
  font-weight: 600;
  margin-bottom: 24px;
  letter-spacing: .5px;
}

/* ===== 主卡片容器 ===== */
form {
  max-width: 520px;
  margin: 0 auto;
  background: #ffffff;
  padding: 28px 26px 30px;
  border-radius: 14px;
  box-shadow:
    0 1px 3px rgba(0,0,0,.08),
    0 8px 24px rgba(0,0,0,.06);
  transition: box-shadow .25s ease;
}

form:hover {
  box-shadow:
    0 2px 6px rgba(0,0,0,.12),
    0 12px 32px rgba(0,0,0,.08);
}

/* ===== 表单元素 ===== */
label {
  display: block;
  margin-top: 14px;
  margin-bottom: 6px;
  font-size: 13px;
  color: #5f6368;
}

input,
select {
  width: 100%;
  padding: 12px 14px;
  font-size: 15px;
  border-radius: 10px;
  border: 1px solid #dadce0;
  background: #fff;
  transition: border .2s, box-shadow .2s;
}

input::placeholder {
  color: #9aa0a6;
}

input:focus,
select:focus {
  border-color: #1a73e8;
  box-shadow: 0 0 0 3px rgba(26,115,232,.15);
  outline: none;
}

/* ===== 验证码区域 ===== */
#captcha {
  display: flex;
  align-items: center;
  margin-top: 16px;
  gap: 12px;
  padding: 10px 12px;
  background: #f1f3f4;
  border-radius: 10px;
}

#captcha label {
  margin: 0;
  font-size: 14px;
  color: #3c4043;
  white-space: nowrap;
}

#captcha input {
  width: 100px;
}

/* ===== 提交按钮 ===== */
button {
  width: 100%;
  margin-top: 26px;
  padding: 13px;
  font-size: 16px;
  font-weight: 600;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  color: #fff;
  background: linear-gradient(135deg, #1a73e8, #4285f4);
  transition: transform .15s ease, box-shadow .15s ease, opacity .15s;
}

button:hover {
  opacity: .95;
  transform: translateY(-1px);
  box-shadow: 0 6px 16px rgba(26,115,232,.35);
}

button:active {
  transform: translateY(0);
  box-shadow: none;
}

/* ===== 提示信息 ===== */
#message {
  margin-top: 18px;
  text-align: center;
  font-size: 14px;
  color: #1a73e8;
}

.error {
  color: #d93025;
}
</style>
</head>

<body>

<h1>提交您的网站</h1>

<form id="submitForm">

  <label for="cat1">一级分类</label>
  <select id="cat1" required></select>

  <label for="cat2">二级分类</label>
  <select id="cat2" required></select>

  <label for="name">网站名称</label>
  <input id="name" type="text" required maxlength="50">

  <label for="url">网站网址</label>
  <input id="url" type="url" required placeholder="https://example.com">

  <label for="desc">网站描述（可选）</label>
  <input id="desc" type="text" maxlength="100">

  <div id="captcha">
    <label id="captchaQuestion"></label>
    <input id="captchaAnswer" type="text" required placeholder="答案">
  </div>

  <button type="submit">提交审核</button>
</form>

<div id="message"></div>

<!-- ===== JS 完全保持原样 ===== -->
<script>
let xmlDoc;
let captchaNum1, captchaNum2, captchaAnswer;

function generateCaptcha() {
  captchaNum1 = Math.floor(Math.random() * 10) + 1;
  captchaNum2 = Math.floor(Math.random() * 10) + 1;
  captchaAnswer = captchaNum1 + captchaNum2;
  document.getElementById('captchaQuestion').textContent =
    `${captchaNum1} + ${captchaNum2} = ?`;
}

function getDomain(url) {
  try {
    const hostname = new URL(url).hostname;
    return hostname.startsWith('www.') ? hostname.slice(4) : hostname;
  } catch {
    return '';
  }
}

fetch('/api/data')
  .then(r => r.text())
  .then(t => {
    xmlDoc = new DOMParser().parseFromString(t, 'text/xml');
    buildCat1();
    generateCaptcha();
  })
  .catch(() => alert('加载分类失败，请稍后再试'));

function buildCat1() {
  const cat1 = document.getElementById('cat1');
  cat1.innerHTML = '<option value="">请选择</option>';
  xmlDoc.querySelectorAll('category').forEach(c => {
    const o = document.createElement('option');
    o.value = o.textContent = c.getAttribute('name');
    cat1.appendChild(o);
  });
  cat1.onchange = buildCat2;
}

function buildCat2() {
  const cat2 = document.getElementById('cat2');
  cat2.innerHTML = '<option value="">请选择</option>';
  const catName = document.getElementById('cat1').value;
  if (!catName) return;
  xmlDoc.querySelectorAll(`category[name="${catName}"] subcategory`)
    .forEach(s => {
      const o = document.createElement('option');
      o.value = o.textContent = s.getAttribute('name');
      cat2.appendChild(o);
    });
}

function isDomainExists(submitUrl) {
  const submitDomain = getDomain(submitUrl);
  if (!submitDomain) return false;
  return [...xmlDoc.querySelectorAll('link')]
    .some(l => getDomain(l.getAttribute('url')) === submitDomain);
}

document.getElementById('submitForm').onsubmit = async function(e) {
  e.preventDefault();
  if (parseInt(captchaAnswer) !==
      parseInt(document.getElementById('captchaAnswer').value)) {
    alert('验证码错误');
    generateCaptcha();
    return;
  }

  const data = {
    cat1: cat1.value,
    cat2: cat2.value,
    name: name.value.trim(),
    url: url.value.trim(),
    desc: desc.value.trim()
  };

  if (isDomainExists(data.url)) {
    alert('该网站已收录');
    return;
  }

  const res = await fetch('/api/submit', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  });

  if (res.ok) {
    alert('提交成功，等待审核');
    this.reset();
    buildCat1();
    generateCaptcha();
  } else {
    alert(await res.text());
  }
};
</script>

</body>
</html>

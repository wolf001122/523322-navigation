<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>提交网站</title>

  <!-- 与 index.html 一致的样式（假定已在主页面统一引入） -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Cloudflare Turnstile（防机器人） -->
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
</head>

<body>

<div class="card">
  <h2>网站提交</h2>

  <!-- 一级分类 -->
  <div class="form-row">
    <label>一级分类</label>
    <select id="cat1"></select>
  </div>

  <!-- 二级分类 -->
  <div class="form-row">
    <label>二级分类</label>
    <select id="cat2"></select>
  </div>

  <!-- 名称 -->
  <div class="form-row">
    <label>网站名称</label>
    <input id="name" type="text" placeholder="例如：百度" />
  </div>

  <!-- 网址 -->
  <div class="form-row">
    <label>网站地址</label>
    <input id="url" type="url" placeholder="https://example.com" />
  </div>

  <!-- 图标 -->
  <div class="form-row">
    <label>网站图标</label>
    <input id="icon" type="url" placeholder="https://example.com/favicon.ico" />
  </div>

  <!-- 描述 -->
  <div class="form-row">
    <label>网站简介</label>
    <input id="desc" type="text" placeholder="一句话描述（可选）" />
  </div>

  <!-- 防机器人验证（不改变布局） -->
  <div class="form-row" style="justify-content:center">
    <div class="cf-turnstile"
         data-sitekey="0x4AAAAAACGkz4X0J8Vxw1wl"
         data-theme="light">
    </div>
  </div>

  <!-- 提交按钮 -->
  <div class="form-row">
    <button onclick="submitSite()">提交审核</button>
  </div>
</div>

<script>
/* ================= 加载分类数据 ================= */

let navData = [];

fetch('/api/data')
  .then(r => r.text())
  .then(xmlText => {
    const doc = new DOMParser().parseFromString(xmlText, 'text/xml');
    const categories = [...doc.querySelectorAll('category')];

    navData = categories.map(cat => ({
      name: cat.getAttribute('name'),
      subs: [...cat.querySelectorAll('subcategory')].map(sub =>
        sub.getAttribute('name')
      )
    }));

    initCategory();
  });

function initCategory() {
  const cat1 = document.getElementById('cat1');
  const cat2 = document.getElementById('cat2');

  cat1.innerHTML = '<option value="">请选择</option>';
  navData.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.name;
    opt.textContent = c.name;
    cat1.appendChild(opt);
  });

  cat1.onchange = () => {
    cat2.innerHTML = '<option value="">请选择</option>';
    const found = navData.find(c => c.name === cat1.value);
    if (found) {
      found.subs.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s;
        opt.textContent = s;
        cat2.appendChild(opt);
      });
    }
  };
}

/* ================= 提交逻辑 ================= */

async function submitSite() {
  const cat1 = document.getElementById('cat1').value;
  const cat2 = document.getElementById('cat2').value;
  const name = document.getElementById('name').value.trim();
  const url  = document.getElementById('url').value.trim();
  const icon = document.getElementById('icon').value.trim();
  const desc = document.getElementById('desc').value.trim();

  if (!cat1 || !cat2 || !name || !url) {
    alert('请填写完整信息');
    return;
  }

  if (!/^https?:\/\//i.test(url)) {
    alert('网址必须以 http:// 或 https:// 开头');
    return;
  }

  // 防机器人验证
  const token = turnstile.getResponse();
  if (!token) {
    alert('请完成防机器人验证');
    return;
  }

  const payload = {
    cat1,
    cat2,
    name,
    url,
    icon,
    desc,
    token
  };

  try {
    const res = await fetch('/api/submit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const text = await res.text();
    alert(text);

    if (res.ok) {
      document.getElementById('name').value = '';
      document.getElementById('url').value = '';
      document.getElementById('icon').value = '';
      document.getElementById('desc').value = '';
      turnstile.reset();
    }
  } catch (e) {
    alert('提交失败，请稍后再试');
  }
}
</script>

</body>
</html>

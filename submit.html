<div class="submit-box">
  <h1>网站提交</h1>

  <div class="form-row">
    <label>一级分类</label>
    <select id="cat1">
      <option value="">请选择一级分类</option>
    </select>
  </div>

  <div class="form-row">
    <label>二级分类</label>
    <select id="cat2" disabled>
      <option value="">请先选择一级分类</option>
    </select>
  </div>

  <div class="form-row">
    <label>网站名称</label>
    <input id="name">
  </div>

  <div class="form-row">
    <label>网站网址</label>
    <input id="url" placeholder="https://">
  </div>

  <div class="form-row">
    <label>网站简介</label>
    <textarea id="desc"></textarea>
  </div>

  <div class="form-row captcha">
    <span id="captcha-q"></span>
    <input id="captcha-a" placeholder="答案">
  </div>

  <div class="form-row">
    <button onclick="SubmitPage.submit()">提交审核</button>
  </div>

  <div id="msg"></div>
</div>

<style>
.submit-box{
  max-width:720px;margin:0 auto;background:#fff;padding:32px;
  border-radius:12px;box-shadow:0 1px 3px rgba(60,64,67,.3)
}
.form-row{margin-bottom:18px}
label{display:block;font-size:14px;color:#5f6368;margin-bottom:6px}
input,select,textarea{
  width:100%;padding:12px;border:1px solid #dadce0;border-radius:8px
}
textarea{min-height:80px}
button{
  padding:12px 28px;border:none;border-radius:24px;
  background:#1a73e8;color:#fff;cursor:pointer
}
.captcha{display:flex;gap:12px;align-items:center}
.error{color:#d93025;font-size:13px}
.success{color:#188038;font-size:14px}
</style>

<script>
/* ===== 模块化，避免 script 不执行问题 ===== */
window.SubmitPage = (() => {

  const API = '/api/data';
  const SAVE_API = '/api/submit';
  let categories = [];
  let captchaAnswer = 0;

  /* ===== 初始化（立刻执行） ===== */
  init();

  function init(){
    loadCategories();
    generateCaptcha();
  }

  /* ===== 分类来自 Cloudflare KV / NAV_DATA ===== */
  function loadCategories(){
    fetch(API).then(r=>r.text()).then(t=>{
      const xml=new DOMParser().parseFromString(t,'text/xml');
      categories=[...xml.querySelectorAll('category')].map(c=>({
        name:c.getAttribute('name'),
        subs:[...c.querySelectorAll('subcategory')].map(s=>s.getAttribute('name'))
      }));

      const cat1=document.getElementById('cat1');
      categories.forEach((c,i)=>{
        const o=document.createElement('option');
        o.value=i;
        o.textContent=c.name;
        cat1.appendChild(o);
      });
    });
  }

  document.getElementById('cat1').onchange=e=>{
    const cat2=document.getElementById('cat2');
    cat2.innerHTML='';
    if(e.target.value===''){
      cat2.disabled=true;
      cat2.innerHTML='<option>请先选择一级分类</option>';
      return;
    }
    cat2.disabled=false;
    cat2.innerHTML='<option value="">请选择二级分类</option>';
    categories[e.target.value].subs.forEach(s=>{
      const o=document.createElement('option');
      o.value=s;o.textContent=s;cat2.appendChild(o);
    });
  };

  /* ===== 验证题 ===== */
  function generateCaptcha(){
    const a=Math.floor(Math.random()*10+1);
    const b=Math.floor(Math.random()*10+1);
    captchaAnswer=a+b;
    document.getElementById('captcha-q').textContent=`验证：${a} + ${b} = ?`;
  }

  /* ===== 提交到 KV/NAV_DATA.pending_sites ===== */
  async function submit(){
    const msg=document.getElementById('msg');
    msg.innerHTML='';

    const c1=document.getElementById('cat1').value;
    const c2=document.getElementById('cat2').value;
    const name=document.getElementById('name').value.trim();
    const url=document.getElementById('url').value.trim();
    const desc=document.getElementById('desc').value.trim();
    const cap=document.getElementById('captcha-a').value.trim();

    if(!c1||!c2||!name||!url){
      msg.innerHTML='<div class="error">请填写完整信息</div>';return;
    }
    if(!/^https?:\/\//.test(url)){
      msg.innerHTML='<div class="error">网址格式错误</div>';return;
    }
    if(Number(cap)!==captchaAnswer){
      msg.innerHTML='<div class="error">验证错误</div>';
      generateCaptcha();return;
    }

    const payload={
      cat1:categories[c1].name,
      cat2:c2,
      name,url,desc,
      id:Date.now(),
      time:new Date().toISOString()
    };

    const res=await fetch(SAVE_API,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });

    if(res.ok){
      msg.innerHTML='<div class="success">提交成功，等待审核</div>';
      generateCaptcha();
    }else{
      msg.innerHTML='<div class="error">提交失败</div>';
    }
  }

  return { submit };

})();
</script>

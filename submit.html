<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>网站提交 - 导航</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<link rel="icon" href="/favicon.ico" type="image/x-icon">

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
  background:#f8f9fa;
  color:#202124;
  min-height:100vh;
}
.container{
  max-width:720px;
  margin:40px auto;
  background:#fff;
  padding:32px;
  border-radius:16px;
  box-shadow:0 4px 12px rgba(0,0,0,.12);
}
h1{
  font-size:26px;
  margin-bottom:24px;
  text-align:center;
}
form input,form select,form textarea{
  width:100%;
  margin:10px 0;
  padding:10px;
  font-size:15px;
  border:1px solid #dadce0;
  border-radius:8px;
}
form textarea{min-height:80px}
button{
  margin-top:16px;
  padding:12px;
  width:100%;
  font-size:16px;
  background:#1a73e8;
  color:#fff;
  border:none;
  border-radius:10px;
  cursor:pointer;
}
button:hover{opacity:.9}
#captchaQuestion{
  font-weight:bold;
  margin:12px 0;
  color:#1a73e8;
}
#msg{
  margin-top:16px;
  font-size:14px;
}
.back{
  display:block;
  margin-top:24px;
  text-align:center;
  color:#1a73e8;
  text-decoration:none;
}
</style>
</head>

<body>
<div class="container">
  <h1>网站提交</h1>

  <form onsubmit="submitSite(event)">
    <select id="c1" required></select>
    <select id="c2" required></select>

    <input id="name" placeholder="网站名称" required>
    <input id="url" placeholder="https://example.com" required>
    <textarea id="desc" placeholder="网站简介" required></textarea>

    <!-- 蜜罐 -->
    <input id="hp" style="display:none" autocomplete="off" readonly>

    <div id="captchaQuestion"></div>
    <input id="captchaAnswer" placeholder="请输入验证码答案" required>

    <button>提交</button>
  </form>

  <p id="msg"></p>

  <a class="back" href="/">← 返回首页</a>
</div>

<script>
const API='/api/data';

let data;
const c1=document.getElementById('c1');
const c2=document.getElementById('c2');
const nameInput=document.getElementById('name');
const urlInput=document.getElementById('url');
const descInput=document.getElementById('desc');
const hp=document.getElementById('hp');
const msg=document.getElementById('msg');
const captchaQuestion=document.getElementById('captchaQuestion');
const captchaAnswer=document.getElementById('captchaAnswer');

/* ===== 读取分类 ===== */
fetch(API).then(r=>r.text()).then(t=>{
  const xml=new DOMParser().parseFromString(t,'text/xml');
  data=[...xml.querySelectorAll('category')].map(c=>({
    name:c.getAttribute('name'),
    subs:[...c.querySelectorAll('subcategory')].map(s=>({
      name:s.getAttribute('name')
    }))
  }));
  initCats();
  generateCaptcha();
});

/* ===== 分类初始化 ===== */
function initCats(){
  c1.innerHTML='<option value="">请选择一级分类</option>';
  data.forEach((cat,i)=>{
    const o=document.createElement('option');
    o.value=i;o.textContent=cat.name;
    c1.appendChild(o);
  });
  c1.onchange=()=>{
    c2.innerHTML='<option value="">请选择二级分类</option>';
    if(c1.value!==''){
      data[c1.value].subs.forEach(sub=>{
        const o=document.createElement('option');
        o.textContent=sub.name;
        c2.appendChild(o);
      });
    }
  };
}

/* ===== 验证码 ===== */
function generateCaptcha(){
  const a=Math.floor(Math.random()*10)+1;
  const b=Math.floor(Math.random()*10)+1;
  const ops=['+','-','×'];
  const op=ops[Math.floor(Math.random()*ops.length)];
  let q,ans;
  if(op==='+'){q=`${a}+${b}=?`;ans=a+b;}
  if(op==='-'){q=`${a}-${b}=?`;ans=a-b;}
  if(op==='×'){q=`${a}×${b}=?`;ans=a*b;}
  captchaQuestion.textContent='验证码：'+q;
  window.correctAnswer=ans;
}

/* ===== 提交处理（与你原逻辑一致） ===== */
function submitSite(e){
  e.preventDefault();

  if(hp.value!==''){
    msg.textContent='异常操作，已阻止';
    return;
  }

  const userAns=parseInt(captchaAnswer.value,10);
  if(isNaN(userAns)||userAns!==window.correctAnswer){
    msg.textContent='验证码错误';
    generateCaptcha();
    captchaAnswer.value='';
    return;
  }

  const submittedUrl=urlInput.value.trim();
  if(!submittedUrl){
    msg.textContent='URL不能为空';
    return;
  }

  let submittedRoot='';
  try{
    let h=new URL(submittedUrl).hostname.toLowerCase();
    if(h.startsWith('www.'))h=h.slice(4);
    const p=h.split('.');
    if(p.length<=2) submittedRoot=h;
    else{
      const cs=['cn','uk','jp','de','fr','au','br','ru','in','ca','it','es','nl','kr','tw','hk','sg'];
      const ps=['com','net','org','gov','edu','co','ne','or','go','ac','mil','info','biz'];
      if(cs.includes(p.at(-1))&&ps.includes(p.at(-2))) submittedRoot=p.slice(-3).join('.');
      else submittedRoot=p.slice(-2).join('.');
    }
  }catch{
    msg.textContent='URL格式错误';
    return;
  }

  fetch(API).then(r=>r.text()).then(text=>{
    const doc=new DOMParser().parseFromString(text,'text/xml');
    const roots=new Set();
    doc.querySelectorAll('link').forEach(l=>{
      try{
        let h=new URL(l.getAttribute('url')).hostname.toLowerCase();
        if(h.startsWith('www.'))h=h.slice(4);
        const p=h.split('.');
        let r=p.length<=2?h:p.slice(-2).join('.');
        roots.add(r);
      }catch{}
    });

    if(roots.has(submittedRoot)){
      alert('此一级域名已存在，请勿重复提交');
      msg.textContent='重复域名';
      generateCaptcha();
      return;
    }

    const site={
      cat1:c1.options[c1.selectedIndex]?.text||'',
      cat2:c2.options[c2.selectedIndex]?.text||'',
      name:nameInput.value.trim(),
      url:submittedUrl,
      desc:descInput.value.trim()
    };

    if(!site.cat1||!site.cat2||!site.name||!site.desc){
      msg.textContent='请填写完整信息';
      generateCaptcha();
      return;
    }

    msg.textContent='提交中...';
    fetch('/api/submit',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(site)
    }).then(r=>r.text()).then(t=>{
      if(t.includes('成功')){
        msg.textContent='提交成功，等待审核';
        e.target.reset();
        generateCaptcha();
        c1.selectedIndex=0;
        c2.innerHTML='<option value="">请选择二级分类</option>';
      }else{
        msg.textContent='提交失败：'+t;
        generateCaptcha();
      }
    }).catch(()=>{
      msg.textContent='网络错误';
      generateCaptcha();
    });
  });
}
</script>
</body>
</html>
